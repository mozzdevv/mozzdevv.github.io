---
export interface Props {
  contentId?: string;
}
const { contentId = "docs-article-content" } = Astro.props;

import Copy from "@lucide/astro/icons/copy";
import ChevronDown from "@lucide/astro/icons/chevron-down";
import FileText from "@lucide/astro/icons/file-text";
---

<div class="relative inline-flex items-center bg-secondary rounded-md" id="copy-page-dropdown" data-content-id={contentId}>
  <button
    type="button"
    class="inline-flex items-center justify-center gap-1.5 h-7 px-2.5 text-xs font-medium text-secondary-foreground hover:bg-secondary-foreground/10 rounded-l-md transition-colors"
    id="copy-page-button"
  >
    <span id="copy-page-icon">
      <Copy class="size-3" />
    </span>
    <span class="hidden sm:inline">Copy Page</span>
  </button>
  <div class="w-px h-4 bg-secondary-foreground/20"></div>
  <button
    type="button"
    class="inline-flex items-center justify-center size-7 text-sm font-medium text-secondary-foreground hover:bg-secondary-foreground/10 rounded-r-md transition-colors"
    id="copy-page-trigger"
  >
    <ChevronDown class="size-3" />
  </button>
  <div
    class="absolute right-0 top-full mt-2 w-48 bg-background border border-border rounded-lg shadow-lg opacity-0 invisible transition-all duration-200 z-50"
    id="copy-page-menu"
  >
    <div class="py-1">
      <button
        type="button"
        class="w-full flex items-center gap-3 px-3 py-2 text-sm text-muted-foreground hover:text-foreground hover:bg-muted transition-colors"
        data-copy-action="markdown"
      >
        <FileText class="size-4" />
        View as Markdown
      </button>
      <button
        type="button"
        class="w-full flex items-center gap-3 px-3 py-2 text-sm text-muted-foreground hover:text-foreground hover:bg-muted transition-colors"
        data-copy-action="claude"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="icon size-4 text-base-900 dark:text-white"
        >
          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
          <path
            d="M3 5m0 2a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z"
          ></path>
          <path d="M7 15v-6l2 2l2 -2v6"></path>
          <path d="M14 13l2 2l2 -2m-2 2v-6"></path>
        </svg>
        Open in Claude
      </button>
      <button
        type="button"
        class="w-full flex items-center gap-3 px-3 py-2 text-sm text-muted-foreground hover:text-foreground hover:bg-muted transition-colors"
        data-copy-action="chatgpt"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
          <path d="M11.217 19.384a3.501 3.501 0 0 0 6.783 -1.217v-5.167l-6 -3.35"
          ></path>
          <path
            d="M5.214 15.014a3.501 3.501 0 0 0 4.446 5.266l4.34 -2.534v-6.946"
          ></path>
          <path
            d="M6 7.63c-1.391 -.236 -2.787 .395 -3.534 1.689a3.474 3.474 0 0 0 1.271 4.745l4.263 2.514l6 -3.348"
          ></path>
          <path
            d="M12.783 4.616a3.501 3.501 0 0 0 -6.783 1.217v5.067l6 3.45"
          ></path>
          <path
            d="M18.786 8.986a3.501 3.501 0 0 0 -4.446 -5.266l-4.34 2.534v6.946"
          ></path>
          <path
            d="M18 16.302c1.391 .236 2.787 -.395 3.534 -1.689a3.474 3.474 0 0 0 -1.271 -4.745l-4.308 -2.514l-5.955 3.42"
          ></path>
        </svg>
        Open in ChatGPT
      </button>
    </div>
  </div>
</div>

<script>
  function initCopyPageButton() {
    const dropdown = document.getElementById("copy-page-dropdown");
    if (!dropdown || dropdown.hasAttribute("data-initialized")) return;
    dropdown.setAttribute("data-initialized", "true");

    const contentId =
      dropdown.getAttribute("data-content-id") || "docs-article-content";
    const copyButton = document.getElementById("copy-page-button");
    const copyTrigger = document.getElementById("copy-page-trigger");
    const copyMenu = document.getElementById("copy-page-menu");
    const copyIcon = document.getElementById("copy-page-icon");

    const copyIconOriginal = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>`;
    const copyIconSuccess = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"></path></svg>`;

    function toggleCopyMenu() {
      const isOpen = !copyMenu?.classList.contains("invisible");
      if (isOpen) {
        copyMenu?.classList.add("opacity-0", "invisible");
        copyMenu?.classList.remove("opacity-100", "visible");
      } else {
        copyMenu?.classList.remove("opacity-0", "invisible");
        copyMenu?.classList.add("opacity-100", "visible");
      }
    }

    function closeCopyMenu() {
      copyMenu?.classList.add("opacity-0", "invisible");
      copyMenu?.classList.remove("opacity-100", "visible");
    }

    // Simple HTML to Markdown converter
    function htmlToMarkdown(element: Element | null): string {
      if (!element) return "";

      function processNode(node: Node): string {
        if (node.nodeType === Node.TEXT_NODE) {
          return node.textContent || "";
        }

        if (node.nodeType !== Node.ELEMENT_NODE) return "";

        const el = node as Element;
        const tag = el.tagName.toLowerCase();
        const children = Array.from(el.childNodes).map(processNode).join("");

        switch (tag) {
          case "h1":
            return `# ${children}\n\n`;
          case "h2":
            return `## ${children}\n\n`;
          case "h3":
            return `### ${children}\n\n`;
          case "h4":
            return `#### ${children}\n\n`;
          case "p":
            return `${children}\n\n`;
          case "strong":
          case "b":
            return `**${children}**`;
          case "em":
          case "i":
            return `*${children}*`;
          case "code":
            if (el.parentElement?.tagName.toLowerCase() === "pre") {
              return children;
            }
            return `\`${children}\``;
          case "pre":
            const codeEl = el.querySelector("code");
            const code = codeEl ? codeEl.textContent : children;
            return `\`\`\`\n${code}\n\`\`\`\n\n`;
          case "a":
            const href = el.getAttribute("href") || "";
            return `[${children}](${href})`;
          case "ul":
            return (
              Array.from(el.children)
                .map((li) => `- ${processNode(li).trim()}`)
                .join("\n") + "\n\n"
            );
          case "ol":
            return (
              Array.from(el.children)
                .map((li, i) => `${i + 1}. ${processNode(li).trim()}`)
                .join("\n") + "\n\n"
            );
          case "li":
            return children;
          case "blockquote":
            return `> ${children.trim()}\n\n`;
          case "hr":
            return `---\n\n`;
          case "br":
            return "\n";
          case "div":
          case "section":
          case "article":
          case "span":
            return children;
          default:
            return children;
        }
      }

      return processNode(element)
        .replace(/\n{3,}/g, "\n\n")
        .trim();
    }

    function openMarkdownInNewTab() {
      const content = document.getElementById(contentId);
      const markdown = htmlToMarkdown(content);
      const blob = new Blob([markdown], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank");
    }

    // Main copy button - copies page text to clipboard
    copyButton?.addEventListener("click", async () => {
      const content = document.getElementById(contentId);
      const pageContent = content?.innerText || "";
      await navigator.clipboard.writeText(pageContent);

      // Update icon temporarily
      if (copyIcon) {
        copyIcon.innerHTML = copyIconSuccess;
        setTimeout(() => {
          copyIcon.innerHTML = copyIconOriginal;
        }, 2000);
      }
    });

    copyTrigger?.addEventListener("click", toggleCopyMenu);

    // Close dropdown when clicking outside
    document.addEventListener("click", (e) => {
      const target = e.target as Element;
      if (!target?.closest("#copy-page-dropdown")) {
        closeCopyMenu();
      }
    });

    // Handle dropdown actions
    document.querySelectorAll("[data-copy-action]").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const action = btn.getAttribute("data-copy-action");
        const pageUrl = window.location.href;

        if (action === "markdown") {
          openMarkdownInNewTab();
        } else if (action === "claude") {
          const prompt = `I'm looking at this documentation: ${pageUrl}\nHelp me understand how to use it. Be ready to explain concepts, give examples, or help debug based on it.`;
          const encodedContent = encodeURIComponent(prompt);
          window.open(`https://claude.ai/new?q=${encodedContent}`, "_blank");
        } else if (action === "chatgpt") {
          const prompt = `I'm looking at this documentation: ${pageUrl}\nHelp me understand how to use it. Be ready to explain concepts, give examples, or help debug based on it.`;
          const encodedContent = encodeURIComponent(prompt);
          window.open(`https://chat.openai.com/?q=${encodedContent}`, "_blank");
        }

        closeCopyMenu();
      });
    });
  }

  initCopyPageButton();
</script>
