---
import { cn } from "@/utils/cn";
import type { HTMLAttributes } from "astro/types";

export interface Props extends HTMLAttributes<"button"> {
  variant?: "default" | "outline";
  size?: "sm" | "default" | "lg";
  pressed?: boolean;
  disabled?: boolean;
}

const {
  variant = "default",
  size = "default",
  pressed = false,
  disabled = false,
  class: className,
  ...props
} = Astro.props;

const baseClasses = cn(
  "inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium",
  "ring-offset-background transition-colors",
  "hover:bg-muted hover:text-muted-foreground",
  "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
  "disabled:pointer-events-none disabled:opacity-50",
  "[&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  // Pressed state - must come after hover to take precedence
  "data-[state=on]:bg-accent data-[state=on]:text-accent-foreground"
);

const variantClasses = {
  default: "border border-input bg-transparent",
  outline: "border border-input bg-transparent",
};

const sizeClasses = {
  sm: "h-8 px-2 min-w-8",
  default: "h-9 px-2.5 min-w-9",
  lg: "h-10 px-3 min-w-10",
};

const classes = cn(
  baseClasses,
  variantClasses[variant],
  sizeClasses[size],
  className
);
---

<button
  type="button"
  data-toggle
  data-state={pressed ? "on" : "off"}
  aria-pressed={pressed}
  disabled={disabled}
  class={classes}
  {...props}
>
  <slot />
</button>

<script>
  function initToggles() {
    document.querySelectorAll('[data-toggle]').forEach(toggle => {
      if (toggle.hasAttribute('data-initialized')) return;
      toggle.setAttribute('data-initialized', 'true');
      
      toggle.addEventListener('click', () => {
        const isPressed = toggle.getAttribute('aria-pressed') === 'true';
        const newState = !isPressed;
        
        toggle.setAttribute('aria-pressed', String(newState));
        toggle.setAttribute('data-state', newState ? 'on' : 'off');
        
        // Dispatch custom event
        toggle.dispatchEvent(new CustomEvent('toggle', {
          bubbles: true,
          detail: { pressed: newState }
        }));
      });
    });
  }
  
  initToggles();
  document.addEventListener('astro:page-load', initToggles);
</script>
