---
import { cn } from '@/utils/cn';
import type { HTMLAttributes } from 'astro/types';

export interface Props extends HTMLAttributes<'div'> {
  loop?: boolean;
  autoplay?: boolean;
  autoplayDelay?: number;
  pauseOnHover?: boolean;
  slidesPerView?: number | 'auto';
  spacing?: number;
  orientation?: 'horizontal' | 'vertical';
}

const {
  loop = false,
  autoplay = false,
  autoplayDelay = 4000,
  pauseOnHover = true,
  slidesPerView = 1,
  spacing = 16,
  orientation = 'horizontal',
  class: className,
  ...props
} = Astro.props;

const classes = cn('relative', className);
---

<div
  class={classes}
  data-carousel
  data-loop={loop ? 'true' : undefined}
  data-autoplay={autoplay ? 'true' : undefined}
  data-autoplay-delay={autoplayDelay}
  data-pause-on-hover={pauseOnHover ? 'true' : undefined}
  data-slides-per-view={slidesPerView}
  data-spacing={spacing}
  data-orientation={orientation}
  {...props}
>
  <slot />
</div>

<script>
  import KeenSlider from 'keen-slider';

  function initCarousels() {
    document.querySelectorAll('[data-carousel]').forEach((carousel) => {
      if (carousel.hasAttribute('data-carousel-initialized')) return;
      carousel.setAttribute('data-carousel-initialized', 'true');

      const content = carousel.querySelector('[data-carousel-content]') as HTMLElement;
      if (!content) return;

      const loop = carousel.getAttribute('data-loop') === 'true';
      const autoplay = carousel.getAttribute('data-autoplay') === 'true';
      const autoplayDelay = parseInt(carousel.getAttribute('data-autoplay-delay') || '4000');
      const pauseOnHover = carousel.getAttribute('data-pause-on-hover') === 'true';
      const slidesPerView = carousel.getAttribute('data-slides-per-view');
      const spacing = parseInt(carousel.getAttribute('data-spacing') || '16');
      const orientation = carousel.getAttribute('data-orientation') as 'horizontal' | 'vertical';

      const perView = slidesPerView === 'auto' ? 'auto' : parseInt(slidesPerView || '1');

      let autoplayInterval: ReturnType<typeof setInterval> | null = null;

      const slider = new KeenSlider(content, {
        loop,
        mode: 'snap',
        slides: {
          perView,
          spacing,
        },
        vertical: orientation === 'vertical',
        created(s) {
          // Update dots
          updateDots(s.track.details.rel);
          updateArrows(s);

          // Start autoplay if enabled
          if (autoplay) {
            startAutoplay();
          }
        },
        slideChanged(s) {
          updateDots(s.track.details.rel);
          updateArrows(s);
        },
      });

      function startAutoplay() {
        if (autoplayInterval) clearInterval(autoplayInterval);
        autoplayInterval = setInterval(() => {
          slider.next();
        }, autoplayDelay);
      }

      function stopAutoplay() {
        if (autoplayInterval) {
          clearInterval(autoplayInterval);
          autoplayInterval = null;
        }
      }

      // Pause on hover
      if (autoplay && pauseOnHover) {
        content.addEventListener('mouseenter', stopAutoplay);
        content.addEventListener('mouseleave', startAutoplay);
      }

      function updateDots(currentSlide: number) {
        const dots = carousel.querySelectorAll('[data-carousel-dot]');
        dots.forEach((dot, index) => {
          if (index === currentSlide) {
            dot.setAttribute('data-active', 'true');
          } else {
            dot.removeAttribute('data-active');
          }
        });
      }

      function updateArrows(s: typeof slider) {
        const prevBtn = carousel.querySelector('[data-carousel-prev]');
        const nextBtn = carousel.querySelector('[data-carousel-next]');
        
        if (!loop) {
          if (prevBtn) {
            if (s.track.details.rel === 0) {
              prevBtn.setAttribute('disabled', 'true');
            } else {
              prevBtn.removeAttribute('disabled');
            }
          }
          if (nextBtn) {
            if (s.track.details.rel === s.track.details.maxIdx) {
              nextBtn.setAttribute('disabled', 'true');
            } else {
              nextBtn.removeAttribute('disabled');
            }
          }
        }
      }

      // Previous button
      const prevBtn = carousel.querySelector('[data-carousel-prev]');
      prevBtn?.addEventListener('click', () => slider.prev());

      // Next button
      const nextBtn = carousel.querySelector('[data-carousel-next]');
      nextBtn?.addEventListener('click', () => slider.next());

      // Dots navigation
      const dots = carousel.querySelectorAll('[data-carousel-dot]');
      dots.forEach((dot, index) => {
        dot.addEventListener('click', () => slider.moveToIdx(index));
      });

      // Store slider instance for cleanup
      (carousel as any).__keenSlider = slider;
    });
  }

  initCarousels();
  document.addEventListener('astro:page-load', initCarousels);
</script>

<style is:global>
  @import 'keen-slider/keen-slider.min.css';
</style>
