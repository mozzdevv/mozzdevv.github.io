---
import { cn } from '@/utils/cn';
import type { HTMLAttributes } from 'astro/types';

export interface Props extends HTMLAttributes<'div'> {
  max?: number;
  size?: 'sm' | 'default' | 'lg';
}

const { max, size = 'default', class: className, ...props } = Astro.props;

const sizeStyles = {
  sm: 'size-8',
  default: 'size-10',
  lg: 'size-12',
};

const classes = cn(
  'flex -space-x-3',
  className
);
---

<div
  class={classes}
  data-avatar-group
  data-max={max}
  data-size={size}
  {...props}
>
  <slot />
</div>

<script>
  function initAvatarGroups() {
    document.querySelectorAll('[data-avatar-group]').forEach((group) => {
      if (group.hasAttribute('data-initialized')) return;
      group.setAttribute('data-initialized', 'true');

      const max = parseInt(group.getAttribute('data-max') || '0');
      const size = group.getAttribute('data-size') || 'default';

      if (max <= 0) return;

      const avatars = group.querySelectorAll(':scope > *');
      const totalAvatars = avatars.length;

      if (totalAvatars <= max) return;

      // Hide excess avatars
      avatars.forEach((avatar, index) => {
        if (index >= max) {
          (avatar as HTMLElement).style.display = 'none';
        }
      });

      // Create overflow indicator
      const overflow = totalAvatars - max;
      const overflowEl = document.createElement('span');
      
      const sizeClasses: Record<string, string> = {
        sm: 'size-8 text-xs',
        default: 'size-10 text-sm',
        lg: 'size-12 text-base',
      };

      overflowEl.className = `relative flex shrink-0 items-center justify-center rounded-full border-2 border-background bg-muted text-muted-foreground font-medium ${sizeClasses[size]}`;
      overflowEl.textContent = `+${overflow}`;
      group.appendChild(overflowEl);
    });
  }

  initAvatarGroups();
  document.addEventListener('astro:page-load', initAvatarGroups);
</script>
