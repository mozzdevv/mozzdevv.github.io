---
import { cn } from "@/utils/cn";
import type { HTMLAttributes } from "astro/types";

export interface Props extends HTMLAttributes<"div"> {}

const { class: className, ...props } = Astro.props;

const classes = cn(
  "flex h-9 items-center gap-1 rounded-md border bg-background p-1",
  className
);
---

<div class={classes} data-menubar role="menubar" {...props}>
  <slot />
</div>

<script>
  function initMenubars() {
    document.querySelectorAll("[data-menubar]").forEach((menubar) => {
      if (menubar.hasAttribute("data-initialized")) return;
      menubar.setAttribute("data-initialized", "true");

      const menus = menubar.querySelectorAll("[data-menubar-menu]");
      let activeMenu: Element | null = null;
      let isMenubarActive = false;

      function closeAllMenus() {
        menus.forEach((menu) => {
          const content = menu.querySelector("[data-menubar-content]");
          const trigger = menu.querySelector("[data-menubar-trigger]");
          if (content) content.setAttribute("hidden", "");
          if (trigger) {
            trigger.setAttribute("aria-expanded", "false");
            trigger.setAttribute("data-state", "closed");
          }
        });
        activeMenu = null;
        isMenubarActive = false;
      }

      function openMenu(menu: Element) {
        closeAllMenus();
        const content = menu.querySelector("[data-menubar-content]");
        const trigger = menu.querySelector("[data-menubar-trigger]");
        if (content) content.removeAttribute("hidden");
        if (trigger) {
          trigger.setAttribute("aria-expanded", "true");
          trigger.setAttribute("data-state", "open");
        }
        activeMenu = menu;
        isMenubarActive = true;

        // Focus first item
        const firstItem = content?.querySelector("[data-menubar-item]:not([data-disabled])") as HTMLElement;
        if (firstItem) firstItem.focus();
      }

      menus.forEach((menu) => {
        const trigger = menu.querySelector("[data-menubar-trigger]");
        const content = menu.querySelector("[data-menubar-content]");

        if (trigger) {
          trigger.addEventListener("click", (e) => {
            e.stopPropagation();
            if (activeMenu === menu && isMenubarActive) {
              closeAllMenus();
            } else {
              openMenu(menu);
            }
          });

          trigger.addEventListener("mouseenter", () => {
            if (isMenubarActive && activeMenu !== menu) {
              openMenu(menu);
            }
          });

          trigger.addEventListener("keydown", (e) => {
            const event = e as KeyboardEvent;
            if (event.key === "Enter" || event.key === " ") {
              event.preventDefault();
              openMenu(menu);
            } else if (event.key === "ArrowDown") {
              event.preventDefault();
              openMenu(menu);
            } else if (event.key === "ArrowRight" || event.key === "ArrowLeft") {
              event.preventDefault();
              const menuArray = Array.from(menus);
              const currentIndex = menuArray.indexOf(menu);
              const nextIndex = event.key === "ArrowRight" 
                ? (currentIndex + 1) % menuArray.length
                : (currentIndex - 1 + menuArray.length) % menuArray.length;
              const nextTrigger = menuArray[nextIndex].querySelector("[data-menubar-trigger]") as HTMLElement;
              if (nextTrigger) {
                nextTrigger.focus();
                if (isMenubarActive) openMenu(menuArray[nextIndex]);
              }
            }
          });
        }

        if (content) {
          content.addEventListener("keydown", (e) => {
            const event = e as KeyboardEvent;
            const items = content.querySelectorAll("[data-menubar-item]:not([data-disabled]), [data-menubar-checkbox-item]:not([data-disabled]), [data-menubar-radio-item]:not([data-disabled]), [data-menubar-sub-trigger]:not([data-disabled])");
            const itemArray = Array.from(items) as HTMLElement[];
            const currentIndex = itemArray.indexOf(document.activeElement as HTMLElement);

            if (event.key === "ArrowDown") {
              event.preventDefault();
              const nextIndex = (currentIndex + 1) % itemArray.length;
              itemArray[nextIndex]?.focus();
            } else if (event.key === "ArrowUp") {
              event.preventDefault();
              const prevIndex = (currentIndex - 1 + itemArray.length) % itemArray.length;
              itemArray[prevIndex]?.focus();
            } else if (event.key === "Escape") {
              event.preventDefault();
              closeAllMenus();
              (trigger as HTMLElement)?.focus();
            } else if (event.key === "ArrowRight" || event.key === "ArrowLeft") {
              // Check if we're on a sub-trigger
              const focused = document.activeElement;
              if (event.key === "ArrowRight" && focused?.hasAttribute("data-menubar-sub-trigger")) {
                return; // Let submenu handle it
              }
              
              event.preventDefault();
              const menuArray = Array.from(menus);
              const currentMenuIndex = menuArray.indexOf(menu);
              const nextIndex = event.key === "ArrowRight"
                ? (currentMenuIndex + 1) % menuArray.length
                : (currentMenuIndex - 1 + menuArray.length) % menuArray.length;
              openMenu(menuArray[nextIndex]);
            }
          });
        }
      });

      // Close on outside click
      document.addEventListener("click", (e) => {
        if (!menubar.contains(e.target as Node)) {
          closeAllMenus();
        }
      });

      // Close on escape
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && isMenubarActive) {
          closeAllMenus();
        }
      });
    });
  }

  initMenubars();
  document.addEventListener("astro:page-load", initMenubars);
</script>
