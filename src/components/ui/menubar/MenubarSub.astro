---
import { cn } from "@/utils/cn";
import type { HTMLAttributes } from "astro/types";

export interface Props extends HTMLAttributes<"div"> {}

const { class: className, ...props } = Astro.props;

const classes = cn("relative", className);
---

<div class={classes} data-menubar-sub {...props}>
  <slot />
</div>

<script>
  function initMenubarSubs() {
    document.querySelectorAll("[data-menubar-sub]").forEach((sub) => {
      if (sub.hasAttribute("data-sub-initialized")) return;
      sub.setAttribute("data-sub-initialized", "true");

      const trigger = sub.querySelector("[data-menubar-sub-trigger]");
      const content = sub.querySelector("[data-menubar-sub-content]");

      if (!trigger || !content) return;

      let closeTimeout: ReturnType<typeof setTimeout>;

      function openSubmenu() {
        clearTimeout(closeTimeout);
        content.removeAttribute("hidden");
        trigger.setAttribute("data-state", "open");
        trigger.setAttribute("aria-expanded", "true");
      }

      function closeSubmenu() {
        closeTimeout = setTimeout(() => {
          content.setAttribute("hidden", "");
          trigger.setAttribute("data-state", "closed");
          trigger.setAttribute("aria-expanded", "false");
        }, 100);
      }

      trigger.addEventListener("mouseenter", openSubmenu);
      trigger.addEventListener("mouseleave", closeSubmenu);
      content.addEventListener("mouseenter", () => clearTimeout(closeTimeout));
      content.addEventListener("mouseleave", closeSubmenu);

      trigger.addEventListener("keydown", (e) => {
        const event = e as KeyboardEvent;
        if (event.key === "ArrowRight" || event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          event.stopPropagation();
          openSubmenu();
          const firstItem = content.querySelector("[data-menubar-item]:not([data-disabled])") as HTMLElement;
          if (firstItem) firstItem.focus();
        }
      });

      content.addEventListener("keydown", (e) => {
        const event = e as KeyboardEvent;
        if (event.key === "ArrowLeft" || event.key === "Escape") {
          event.preventDefault();
          event.stopPropagation();
          closeSubmenu();
          (trigger as HTMLElement).focus();
        }
      });
    });
  }

  initMenubarSubs();
  document.addEventListener("astro:page-load", initMenubarSubs);
</script>
