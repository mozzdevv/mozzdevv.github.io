---
import { cn } from "@/utils/cn";
import type { HTMLAttributes } from "astro/types";

export interface Props extends HTMLAttributes<"div"> {
  checked?: boolean;
  disabled?: boolean;
}

const { checked = false, disabled = false, class: className, ...props } = Astro.props;

const classes = cn(
  "relative flex cursor-pointer select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none",
  "focus:bg-accent focus:text-accent-foreground",
  "data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
  className
);
---

<div
  class={classes}
  data-menubar-checkbox-item
  data-checked={checked ? "true" : "false"}
  data-disabled={disabled ? "" : undefined}
  role="menuitemcheckbox"
  aria-checked={checked}
  tabindex={disabled ? -1 : 0}
  {...props}
>
  <span class="absolute left-2 flex size-3.5 items-center justify-center">
    <svg
      class="size-4 hidden data-[checked=true]:block"
      data-check-icon
      data-checked={checked ? "true" : "false"}
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
  </span>
  <slot />
</div>

<script>
  function initMenubarCheckboxItems() {
    document.querySelectorAll("[data-menubar-checkbox-item]:not([data-disabled])").forEach((item) => {
      if (item.hasAttribute("data-checkbox-initialized")) return;
      item.setAttribute("data-checkbox-initialized", "true");

      function toggleCheck() {
        const isChecked = item.getAttribute("data-checked") === "true";
        const newState = !isChecked;
        item.setAttribute("data-checked", newState.toString());
        item.setAttribute("aria-checked", newState.toString());
        
        const icon = item.querySelector("[data-check-icon]");
        if (icon) {
          icon.setAttribute("data-checked", newState.toString());
          if (newState) {
            icon.classList.remove("hidden");
          } else {
            icon.classList.add("hidden");
          }
        }
      }

      item.addEventListener("click", toggleCheck);
      item.addEventListener("keydown", (e) => {
        if ((e as KeyboardEvent).key === "Enter" || (e as KeyboardEvent).key === " ") {
          e.preventDefault();
          toggleCheck();
        }
      });
    });
  }

  initMenubarCheckboxItems();
  document.addEventListener("astro:page-load", initMenubarCheckboxItems);
</script>
