---
import { cn } from "@/utils/cn";
import type { HTMLAttributes } from "astro/types";

export interface Props extends HTMLAttributes<"div"> {
  value?: string;
}

const { value, class: className, ...props } = Astro.props;

const classes = cn("", className);
---

<div
  class={classes}
  data-menubar-radio-group
  data-value={value}
  role="group"
  {...props}
>
  <slot />
</div>

<script>
  function initMenubarRadioGroups() {
    document.querySelectorAll("[data-menubar-radio-group]").forEach((group) => {
      if (group.hasAttribute("data-radio-initialized")) return;
      group.setAttribute("data-radio-initialized", "true");

      const items = group.querySelectorAll("[data-menubar-radio-item]");
      const initialValue = group.getAttribute("data-value");

      // Set initial state
      items.forEach((item) => {
        const itemValue = item.getAttribute("data-value");
        const isChecked = itemValue === initialValue;
        item.setAttribute("data-checked", isChecked.toString());
        item.setAttribute("aria-checked", isChecked.toString());
        
        const icon = item.querySelector("[data-radio-icon]");
        if (icon) {
          if (isChecked) {
            icon.classList.remove("hidden");
          } else {
            icon.classList.add("hidden");
          }
        }
      });

      items.forEach((item) => {
        function selectItem() {
          const itemValue = item.getAttribute("data-value");
          group.setAttribute("data-value", itemValue || "");

          items.forEach((i) => {
            const iValue = i.getAttribute("data-value");
            const isChecked = iValue === itemValue;
            i.setAttribute("data-checked", isChecked.toString());
            i.setAttribute("aria-checked", isChecked.toString());
            
            const icon = i.querySelector("[data-radio-icon]");
            if (icon) {
              if (isChecked) {
                icon.classList.remove("hidden");
              } else {
                icon.classList.add("hidden");
              }
            }
          });
        }

        item.addEventListener("click", selectItem);
        item.addEventListener("keydown", (e) => {
          if ((e as KeyboardEvent).key === "Enter" || (e as KeyboardEvent).key === " ") {
            e.preventDefault();
            selectItem();
          }
        });
      });
    });
  }

  initMenubarRadioGroups();
  document.addEventListener("astro:page-load", initMenubarRadioGroups);
</script>
