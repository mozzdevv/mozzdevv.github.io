---
import { cn } from "@/utils/cn";
import type { HTMLAttributes } from "astro/types";

export interface Props extends HTMLAttributes<"aside"> {
  side?: "left" | "right";
  collapsible?: boolean;
  defaultOpen?: boolean;
}

const { 
  side = "left", 
  collapsible = true,
  defaultOpen = true,
  class: className, 
  ...props 
} = Astro.props;

const classes = cn(
  "flex h-full w-64 flex-col bg-sidebar text-sidebar-foreground border-sidebar-border",
  side === "left" ? "border-r" : "border-l",
  className
);
---

<aside
  class={classes}
  data-sidebar
  data-side={side}
  data-state={defaultOpen ? "open" : "closed"}
  data-collapsible={collapsible ? "true" : "false"}
  {...props}
>
  <slot />
</aside>

<script>
  function initSidebars() {
    document.querySelectorAll("[data-sidebar]").forEach((sidebar) => {
      if (sidebar.hasAttribute("data-initialized")) return;
      sidebar.setAttribute("data-initialized", "true");

      // Handle responsive behavior
      const checkMobile = () => {
        const isMobile = window.innerWidth < 768;
        sidebar.setAttribute("data-mobile", isMobile ? "true" : "false");
        
        // On mobile, sidebar starts closed
        if (isMobile && sidebar.getAttribute("data-state") === "open") {
          sidebar.setAttribute("data-state", "closed");
        }
      };

      checkMobile();
      window.addEventListener("resize", checkMobile);
    });
  }

  initSidebars();
  document.addEventListener("astro:page-load", initSidebars);
</script>

<style>
  [data-sidebar] {
    transition: width 0.2s ease-in-out, transform 0.2s ease-in-out;
  }

  [data-sidebar][data-state="closed"][data-collapsible="true"] {
    width: 0;
    overflow: hidden;
  }

  /* Mobile styles */
  @media (max-width: 767px) {
    [data-sidebar] {
      position: fixed;
      top: 0;
      bottom: 0;
      z-index: 50;
    }

    [data-sidebar][data-side="left"] {
      left: 0;
    }

    [data-sidebar][data-side="right"] {
      right: 0;
    }

    [data-sidebar][data-state="closed"] {
      transform: translateX(-100%);
    }

    [data-sidebar][data-side="right"][data-state="closed"] {
      transform: translateX(100%);
    }
  }
</style>
