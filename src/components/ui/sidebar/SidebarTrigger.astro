---
import { cn } from "@/utils/cn";
import type { HTMLAttributes } from "astro/types";
import PanelLeft from "@lucide/astro/icons/panel-left";

export interface Props extends HTMLAttributes<"button"> {
  for?: string;
}

const { for: sidebarId, class: className, ...props } = Astro.props;

const classes = cn(
  "inline-flex size-8 items-center justify-center rounded-md text-sm font-medium transition-colors",
  "hover:bg-accent hover:text-accent-foreground",
  "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",
  className
);
---

<button
  type="button"
  class={classes}
  data-sidebar-trigger
  data-target={sidebarId}
  aria-label="Toggle sidebar"
  {...props}
>
  <slot>
    <PanelLeft class="size-4" />
  </slot>
</button>

<script>
  function initSidebarTriggers() {
    document.querySelectorAll("[data-sidebar-trigger]").forEach((trigger) => {
      if (trigger.hasAttribute("data-trigger-initialized")) return;
      trigger.setAttribute("data-trigger-initialized", "true");

      trigger.addEventListener("click", () => {
        // Find the sidebar - by target ID, or in same container, or nearest one
        const targetId = trigger.getAttribute("data-target");
        let sidebar = null;
        
        if (targetId) {
          sidebar = document.querySelector(`[data-sidebar][id="${targetId}"]`);
        } else {
          // Look for sidebar in the same parent container first
          const container = trigger.closest('.flex, [data-preview], [class*="border"]');
          if (container) {
            sidebar = container.querySelector("[data-sidebar]");
          }
          // Fallback to any sidebar on page
          if (!sidebar) {
            sidebar = document.querySelector("[data-sidebar]");
          }
        }

        if (sidebar) {
          const currentState = sidebar.getAttribute("data-state");
          const newState = currentState === "open" ? "closed" : "open";
          sidebar.setAttribute("data-state", newState);

          // Dispatch custom event
          sidebar.dispatchEvent(new CustomEvent("sidebar-toggle", {
            detail: { open: newState === "open" }
          }));
        }
      });
    });
  }

  initSidebarTriggers();
  document.addEventListener("astro:page-load", initSidebarTriggers);
</script>
