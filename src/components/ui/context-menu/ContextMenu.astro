---
import { cn } from "@/utils/cn";
import type { HTMLAttributes } from "astro/types";

export interface Props extends HTMLAttributes<"div"> {}

const { class: className, ...props } = Astro.props;
---

<div class={cn("relative", className)} data-context-menu {...props}>
  <slot />
</div>

<script>
  function initContextMenus() {
    document.querySelectorAll("[data-context-menu]").forEach((menu) => {
      if (menu.hasAttribute("data-initialized")) return;
      menu.setAttribute("data-initialized", "true");

      const trigger = menu.querySelector("[data-context-menu-trigger]");
      const content = menu.querySelector("[data-context-menu-content]") as HTMLElement;

      if (!trigger || !content) return;

      // Right-click to open
      trigger.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        
        // Close any other open context menus
        document.querySelectorAll("[data-context-menu-content]").forEach((c) => {
          if (c !== content) (c as HTMLElement).hidden = true;
        });

        // Position at cursor
        const x = (e as MouseEvent).clientX;
        const y = (e as MouseEvent).clientY;

        content.style.position = "fixed";
        content.style.left = `${x}px`;
        content.style.top = `${y}px`;
        content.hidden = false;

        // Adjust if menu goes off-screen
        requestAnimationFrame(() => {
          const rect = content.getBoundingClientRect();
          const viewportWidth = window.innerWidth;
          const viewportHeight = window.innerHeight;

          if (rect.right > viewportWidth) {
            content.style.left = `${viewportWidth - rect.width - 8}px`;
          }
          if (rect.bottom > viewportHeight) {
            content.style.top = `${viewportHeight - rect.height - 8}px`;
          }
        });
      });

      // Close on click outside
      document.addEventListener("click", (e) => {
        if (!content.contains(e.target as Node)) {
          content.hidden = true;
        }
      });

      // Close on right-click outside trigger
      document.addEventListener("contextmenu", (e) => {
        if (!trigger.contains(e.target as Node) && !content.hidden) {
          content.hidden = true;
        }
      });

      // Close on Escape
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && !content.hidden) {
          content.hidden = true;
        }
      });

      // Close on scroll
      document.addEventListener("scroll", () => {
        if (!content.hidden) {
          content.hidden = true;
        }
      });

      // Handle item clicks
      content.querySelectorAll("[data-context-menu-item]").forEach((item) => {
        item.addEventListener("click", () => {
          content.hidden = true;
        });
      });

      // Keyboard navigation
      content.addEventListener("keydown", (e) => {
        const event = e as KeyboardEvent;
        const items = Array.from(content.querySelectorAll("[data-context-menu-item]:not([disabled])"));
        const currentIndex = items.indexOf(document.activeElement as Element);

        if (event.key === "ArrowDown") {
          event.preventDefault();
          const nextIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;
          (items[nextIndex] as HTMLElement).focus();
        } else if (event.key === "ArrowUp") {
          event.preventDefault();
          const prevIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
          (items[prevIndex] as HTMLElement).focus();
        }
      });
    });
  }

  initContextMenus();
  document.addEventListener("astro:page-load", initContextMenus);
</script>
