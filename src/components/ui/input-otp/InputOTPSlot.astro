---
import { cn } from "@/utils/cn";
import type { HTMLAttributes } from "astro/types";

export interface Props extends Omit<HTMLAttributes<"input">, "type"> {
  /**
   * Index of the slot (0-based)
   */
  index: number;
  /**
   * Whether to show an invalid state
   */
  invalid?: boolean;
}

const {
  index,
  invalid = false,
  class: className,
  ...props
} = Astro.props;

const classes = cn(
  "relative w-10 h-12 text-center text-lg font-medium",
  "bg-background border border-input rounded-md",
  "transition-all duration-150",
  "focus:z-10 focus:border-primary focus:ring-[3px] focus:ring-primary/10 focus:outline-none",
  "disabled:cursor-not-allowed disabled:opacity-50",
  invalid && "border-destructive focus:border-destructive focus:ring-destructive/10",
  className
);
---

<div data-otp-slot-wrapper class="relative">
  <input
    type="text"
    inputmode="numeric"
    autocomplete="one-time-code"
    maxlength="1"
    class={classes}
    data-otp-slot
    data-otp-index={index}
    aria-label={`Digit ${index + 1}`}
    aria-invalid={invalid ? "true" : undefined}
    {...props}
  />
  <div
    class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 data-[active]:opacity-100"
    data-otp-caret
  >
    <div class="w-px h-6 bg-foreground animate-pulse"></div>
  </div>
</div>

<style>
  /* Show caret when slot is focused and empty */
  [data-otp-slot-wrapper]:has([data-otp-slot]:focus:placeholder-shown) [data-otp-caret] {
    opacity: 1;
  }

  /* Hide caret when slot has value */
  [data-otp-slot-wrapper]:has([data-otp-slot][data-filled]) [data-otp-caret] {
    opacity: 0;
  }
</style>
