---
import ComboboxContent from "@/components/ui/combobox/ComboboxContent.astro";
import ComboboxItem from "@/components/ui/combobox/ComboboxItem.astro";
import ComboboxTrigger from "@/components/ui/combobox/ComboboxTrigger.astro";
import X from "@/components/fundations/icons/X.astro";
import CommandEmpty from "@/components/ui/command/CommandEmpty.astro";
import CommandGroup from "@/components/ui/command/CommandGroup.astro";
import CommandList from "@/components/ui/command/CommandList.astro";
import CommandSeparator from "@/components/ui/command/CommandSeparator.astro";
import Popover from "@/components/ui/popover/Popover.astro";
import { cn } from "@/utils/cn";
import type { HTMLAttributes } from "astro/types";

type ComboboxOption = {
  value: string;
  label: string;
  description?: string;
  meta?: string;
  disabled?: boolean;
};

type ComboboxGroup = {
  heading?: string;
  options: ComboboxOption[];
};

export interface Props extends HTMLAttributes<"div"> {
  options: ComboboxOption[] | ComboboxGroup[];
  value?: string;
  name?: string;
  placeholder?: string;
  searchPlaceholder?: string;
  emptyMessage?: string;
  disabled?: boolean;
  clearable?: boolean;
  inputGroupControl?: boolean;
}

const {
  options = [],
  value = "",
  id,
  name,
  placeholder = "Select an option",
  searchPlaceholder = "Search...",
  emptyMessage = "No results found.",
  disabled = false,
  clearable = false,
  inputGroupControl = false,
  class: className,
  ...props
} = Astro.props;

const isGrouped =
  Array.isArray(options) &&
  options.length > 0 &&
  typeof options[0] === "object" &&
  "options" in options[0];

const normalizedGroups = (isGrouped
  ? (options as ComboboxGroup[])
  : [{ options: options as ComboboxOption[] }]) as ComboboxGroup[];

const selectedOption = normalizedGroups
  .flatMap((group) => group.options)
  .find((option) => option.value === value);
---

<Popover
  class={cn("w-full", className)}
  data-combobox
  data-combobox-value={value}
  data-combobox-placeholder={placeholder}
  data-combobox-disabled={disabled ? "true" : "false"}
  data-combobox-clearable={clearable ? "true" : "false"}
  {...props}
>
  <ComboboxTrigger
    id={id}
    placeholder={selectedOption?.label || placeholder}
    disabled={disabled}
    inputGroupControl={inputGroupControl}
  >
    {clearable && !disabled && (
      <span
        slot="clear-icon"
        class={cn(
          "inline-flex items-center justify-center rounded-sm p-1 text-muted-foreground transition-colors hover:text-foreground",
          !selectedOption && "hidden"
        )}
        data-combobox-clear
        role="button"
        tabindex="0"
        aria-label="Clear selection"
      >
        <X size="sm" />
      </span>
    )}
  </ComboboxTrigger>
  <ComboboxContent>
    <div class="border-b px-3 py-2">
      <input
        type="text"
        data-command-input
        role="combobox"
        aria-expanded="true"
        aria-autocomplete="list"
        aria-haspopup="listbox"
        autocomplete="off"
        autocorrect="off"
        spellcheck="false"
        class="flex h-9 w-full border-0 bg-transparent px-0 text-sm outline-none focus:ring-0 placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50"
        placeholder={searchPlaceholder}
      />
    </div>
    <CommandList>
      <CommandEmpty>{emptyMessage}</CommandEmpty>
      {
        normalizedGroups.map((group, groupIndex) => (
          <>
            <CommandGroup heading={group.heading}>
              {group.options.map((option) => (
                <ComboboxItem
                  value={option.value}
                  label={option.label}
                  description={option.description}
                  meta={option.meta}
                  disabled={option.disabled}
                />
              ))}
            </CommandGroup>
            {groupIndex < normalizedGroups.length - 1 && (
              <CommandSeparator data-combobox-group-separator />
            )}
          </>
        ))
      }
    </CommandList>
  </ComboboxContent>
  {name && <input type="hidden" name={name} value={value} data-combobox-input />}
</Popover>

<script>
  import { ensureUiBootLoaded } from "@/utils/runtime/loader";

  ensureUiBootLoaded();
</script>
