---
import { cn } from '@/utils/cn';
import type { HTMLAttributes } from 'astro/types';

export interface Props extends HTMLAttributes<'button'> {
  id?: string;
  name?: string;
  checked?: boolean;
  disabled?: boolean;
}

const {
  id,
  name,
  checked = false,
  disabled = false,
  class: className,
  ...props
} = Astro.props;

const trackClasses = cn(
  'peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent',
  'transition-colors',
  'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background',
  'disabled:cursor-not-allowed disabled:opacity-50',
  'data-[state=checked]:bg-primary data-[state=unchecked]:bg-input',
  className
);

const thumbClasses = cn(
  'pointer-events-none block size-5 rounded-full bg-background shadow-lg ring-0',
  'transition-transform',
  'data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0'
);
---

<button
  type="button"
  role="switch"
  aria-checked={checked}
  data-state={checked ? 'checked' : 'unchecked'}
  id={id}
  disabled={disabled}
  class={trackClasses}
  data-switch
  {...props}
>
  <span class={thumbClasses} data-state={checked ? 'checked' : 'unchecked'} />
  {name && <input type="hidden" name={name} value={checked ? 'on' : 'off'} data-switch-input />}
</button>

<script>
  document.querySelectorAll('[data-switch]').forEach((switchEl) => {
    switchEl.addEventListener('click', () => {
      const isChecked = switchEl.getAttribute('aria-checked') === 'true';
      const newState = !isChecked;

      switchEl.setAttribute('aria-checked', String(newState));
      switchEl.setAttribute('data-state', newState ? 'checked' : 'unchecked');

      const thumb = switchEl.querySelector('span');
      if (thumb) {
        thumb.setAttribute('data-state', newState ? 'checked' : 'unchecked');
      }

      const hiddenInput = switchEl.querySelector('[data-switch-input]') as HTMLInputElement;
      if (hiddenInput) {
        hiddenInput.value = newState ? 'on' : 'off';
      }

      switchEl.dispatchEvent(new CustomEvent('change', { detail: { checked: newState } }));
    });
  });
</script>
