---
import { cn } from '@/utils/cn';
import type { HTMLAttributes } from 'astro/types';

export interface Props extends HTMLAttributes<'div'> {
  defaultOpen?: boolean;
}

const {
  defaultOpen = false,
  class: className,
  ...props
} = Astro.props;

const classes = cn('w-full', className);
---

<div class={classes} data-collapsible data-state={defaultOpen ? 'open' : 'closed'} {...props}>
  <slot />
</div>

<script>
  function initCollapsibles() {
    document.querySelectorAll('[data-collapsible]').forEach((collapsible) => {
      if (collapsible.hasAttribute('data-initialized')) return;
      collapsible.setAttribute('data-initialized', 'true');

      const trigger = collapsible.querySelector('[data-collapsible-trigger]');
      const content = collapsible.querySelector('[data-collapsible-content]') as HTMLElement;

      if (!trigger || !content) return;

      const isOpen = collapsible.getAttribute('data-state') === 'open';
      content.hidden = !isOpen;
      trigger.setAttribute('aria-expanded', String(isOpen));

      trigger.addEventListener('click', () => {
        const currentState = collapsible.getAttribute('data-state');
        const newState = currentState === 'open' ? 'closed' : 'open';

        collapsible.setAttribute('data-state', newState);
        trigger.setAttribute('data-state', newState);
        trigger.setAttribute('aria-expanded', String(newState === 'open'));
        content.hidden = newState === 'closed';
      });
    });
  }

  initCollapsibles();
  document.addEventListener('astro:page-load', initCollapsibles);
</script>
