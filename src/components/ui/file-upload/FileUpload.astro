---
import { cn } from '@/utils/cn';
import type { HTMLAttributes } from 'astro/types';

export interface Props extends HTMLAttributes<'div'> {
  multiple?: boolean;
  accept?: string;
  maxSize?: number;
  disabled?: boolean;
}

const { 
  multiple = false, 
  accept,
  maxSize,
  disabled = false,
  class: className, 
  ...props 
} = Astro.props;

const classes = cn(
  'file-upload',
  className
);
---

<div
  class={classes}
  data-file-upload
  data-multiple={multiple ? 'true' : undefined}
  data-accept={accept}
  data-max-size={maxSize}
  data-disabled={disabled ? 'true' : undefined}
  {...props}
>
  <slot />
</div>

<script>
  function initFileUploads() {
    document.querySelectorAll('[data-file-upload]').forEach((upload) => {
      if (upload.hasAttribute('data-initialized')) return;
      upload.setAttribute('data-initialized', 'true');

      const input = upload.querySelector('[data-file-upload-input]') as HTMLInputElement;
      const trigger = upload.querySelector('[data-file-upload-trigger]');
      const dropzone = upload.querySelector('[data-file-upload-dropzone]');
      const preview = upload.querySelector('[data-file-upload-preview]');
      const isDisabled = upload.getAttribute('data-disabled') === 'true';

      if (!input || isDisabled) return;

      // Click to open file picker
      if (trigger) {
        trigger.addEventListener('click', () => input.click());
      }

      if (dropzone) {
        dropzone.addEventListener('click', () => input.click());

        // Drag and drop
        dropzone.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropzone.setAttribute('data-drag-over', 'true');
        });

        dropzone.addEventListener('dragleave', () => {
          dropzone.removeAttribute('data-drag-over');
        });

        dropzone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropzone.removeAttribute('data-drag-over');

          const dataTransfer = (e as DragEvent).dataTransfer;
          if (dataTransfer?.files) {
            input.files = dataTransfer.files;
            input.dispatchEvent(new Event('change', { bubbles: true }));
          }
        });
      }

      // Handle file selection
      input.addEventListener('change', () => {
        if (!preview) return;

        const files = input.files;
        if (!files || files.length === 0) {
          preview.innerHTML = '';
          return;
        }

        // Clear existing preview
        preview.innerHTML = '';

        Array.from(files).forEach((file) => {
          const item = document.createElement('div');
          item.className = 'flex items-center gap-2 rounded-md border bg-muted/50 px-3 py-2 text-sm';
          
          const icon = document.createElement('span');
          icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="size-4"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>`;
          
          const name = document.createElement('span');
          name.className = 'flex-1 truncate';
          name.textContent = file.name;
          
          const size = document.createElement('span');
          size.className = 'text-muted-foreground text-xs';
          size.textContent = formatFileSize(file.size);

          const remove = document.createElement('button');
          remove.type = 'button';
          remove.className = 'text-muted-foreground hover:text-foreground';
          remove.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="size-4"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`;
          remove.addEventListener('click', (e) => {
            e.stopPropagation();
            item.remove();
            // Clear input if no more items
            if (preview.children.length === 0) {
              input.value = '';
            }
          });
          
          item.appendChild(icon);
          item.appendChild(name);
          item.appendChild(size);
          item.appendChild(remove);
          preview.appendChild(item);
        });
      });
    });
  }

  function formatFileSize(bytes: number): string {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
  }

  initFileUploads();
  document.addEventListener('astro:page-load', initFileUploads);
</script>
