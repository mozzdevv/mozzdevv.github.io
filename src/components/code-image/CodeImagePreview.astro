---
// Code Image Preview - the centered preview area with editable code and resize handles
import GripVertical from "@lucide/astro/icons/grip-vertical";
---

<div
  class="flex-1 min-h-0 flex flex-col items-center justify-start overflow-auto p-4 lg:p-8 scrollbar-hide"
  id="code-image-wrapper"
>
  <!-- Resizable container + handles -->
  <div class="flex items-center" id="code-image-resizable">
    <!-- Left resize handle -->
    <div
      class="flex items-center justify-center w-5 cursor-col-resize select-none shrink-0 z-10 text-muted-foreground opacity-40 hover:opacity-100 transition-opacity"
      id="resize-handle-left"
      aria-label="Resize left"
    >
      <GripVertical size={14} />
    </div>

    <!-- Export target area -->
    <div id="code-image-export-area" class="w-fit max-w-[920px]">
      <!-- Background -->
      <div
        id="code-image-background"
        class="transition-[padding] duration-200 p-16"
      >
        <!-- Card -->
        <div
          id="code-image-card"
          style="box-shadow: rgba(14, 63, 126, 0.04) 0px 0px 0px 1px, rgba(42, 51, 69, 0.04) 0px 1px 1px -0.5px, rgba(42, 51, 70, 0.04) 0px 3px 3px -1.5px, rgba(42, 51, 70, 0.04) 0px 6px 6px -3px, rgba(14, 63, 126, 0.04) 0px 12px 12px -6px, rgba(14, 63, 126, 0.04) 0px 24px 24px -12px;"
          class="rounded-lg text-xs font-medium bg-card overflow-hidden relative z-1"
        >
          <!-- Code area -->
          <div id="code-area">
            <!-- Loading state -->
            <div
              id="code-image-loading"
              class="flex items-center justify-center p-8 text-muted-foreground text-[13px]"
            >
              <svg
                class="animate-spin size-4 mr-2"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
              </svg>
              Loading highlighter...
            </div>

            <!-- Editor (hidden until Shiki loads) -->
            <div id="code-editor-container" class="hidden">
              <div
                id="code-editor-stack"
                class="relative font-mono text-sm leading-[1.5] [tab-size:2] max-w-full"
              >
                <!-- Highlighted code display (drives the height) -->
                <div
                  id="code-display"
                  class="py-4 px-4 w-full max-w-full box-border whitespace-pre-wrap break-all text-xs font-medium"
                  aria-hidden="true"
                >
                </div>

                <!-- Textarea input (overlays on top) -->
                <textarea
                  id="code-input"
                  class="absolute inset-0 py-4 px-4 w-full max-w-full box-border whitespace-pre-wrap break-all font-[inherit] [tab-size:inherit] text-transparent bg-transparent caret-current [-webkit-text-fill-color:transparent] resize-none border-none outline-none overflow-hidden z-2 focus:outline-none focus:ring-0 focus:shadow-none selection:bg-foreground/20"
                  spellcheck="false"
                  autocomplete="off"
                  autocorrect="off"
                  autocapitalize="off"
                  data-gramm="false"
                  data-gramm_editor="false"
                  data-enable-grammarly="false"></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right resize handle -->
    <div
      class="flex items-center justify-center w-5 cursor-col-resize select-none shrink-0 z-10 text-muted-foreground opacity-40 hover:opacity-100 transition-opacity"
      id="resize-handle-right"
      aria-label="Resize right"
    >
      <GripVertical size={14} />
    </div>
  </div>

  <!-- Width indicator bar (below the resizable container) -->
  <div class="flex items-center gap-2 mt-3" id="width-indicator-wrapper">
    <div class="flex-1 h-px bg-border"></div>
    <button
      type="button"
      id="width-indicator"
      class="text-[11px] text-muted-foreground hover:text-foreground tabular-nums transition-colors shrink-0 ring-0 font-mono"
      title="Click to reset width"
    >
    </button>
    <div class="flex-1 h-px bg-border"></div>
  </div>
</div>

<script>
  // Resize handles controller
  function initResize() {
    const exportArea = document.getElementById("code-image-export-area");
    const handleLeft = document.getElementById("resize-handle-left");
    const handleRight = document.getElementById("resize-handle-right");
    const widthIndicator = document.getElementById("width-indicator");
    const widthWrapper = document.getElementById("width-indicator-wrapper");
    const wrapper = document.getElementById("code-image-wrapper");

    if (!exportArea || !handleLeft || !handleRight) return;
    if (handleLeft.hasAttribute("data-initialized")) return;
    handleLeft.setAttribute("data-initialized", "true");

    let isResizing = false;
    let startX = 0;
    let startWidth = 0;
    let side: "left" | "right" = "right";

    // Sync width indicator with current width
    function updateWidthIndicator() {
      const w = exportArea!.offsetWidth;
      if (widthIndicator) widthIndicator.textContent = `${w} px`;
      if (widthWrapper) widthWrapper.style.width = `${w}px`;
    }

    function startResize(
      e: MouseEvent | TouchEvent,
      resizeSide: "left" | "right",
    ) {
      e.preventDefault();
      isResizing = true;
      side = resizeSide;
      startX = "touches" in e ? e.touches[0].clientX : e.clientX;
      startWidth = exportArea!.offsetWidth;
      document.body.classList.add("is-resizing");

      const handle = resizeSide === "left" ? handleLeft : handleRight;
      handle?.classList.add("dragging");
    }

    function doResize(e: MouseEvent | TouchEvent) {
      if (!isResizing || !exportArea) return;

      const clientX = "touches" in e ? e.touches[0].clientX : e.clientX;
      const delta = clientX - startX;

      const widthDelta = side === "right" ? delta * 2 : -delta * 2;
      const newWidth = Math.max(520, Math.min(startWidth + widthDelta, 920));

      exportArea.style.width = newWidth + "px";
      updateWidthIndicator();
    }

    function stopResize() {
      if (!isResizing) return;
      isResizing = false;
      document.body.classList.remove("is-resizing");
      handleLeft?.classList.remove("dragging");
      handleRight?.classList.remove("dragging");
    }

    // Mouse events
    handleLeft.addEventListener("mousedown", (e) => startResize(e, "left"));
    handleRight.addEventListener("mousedown", (e) => startResize(e, "right"));
    document.addEventListener("mousemove", doResize);
    document.addEventListener("mouseup", stopResize);

    // Touch events
    handleLeft.addEventListener("touchstart", (e) => startResize(e, "left"), {
      passive: false,
    });
    handleRight.addEventListener("touchstart", (e) => startResize(e, "right"), {
      passive: false,
    });
    document.addEventListener("touchmove", doResize, { passive: false });
    document.addEventListener("touchend", stopResize);

    // Click width indicator to reset width
    widthIndicator?.addEventListener("click", () => {
      if (exportArea) {
        exportArea.style.width = "";
        updateWidthIndicator();
      }
    });

    // Initial sync
    updateWidthIndicator();

    // Watch for external width changes (e.g. window resize)
    const observer = new ResizeObserver(() => updateWidthIndicator());
    observer.observe(exportArea);
  }

  initResize();
  document.addEventListener("astro:page-load", initResize);
</script>
