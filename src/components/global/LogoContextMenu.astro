---
/**
 * LogoContextMenu - Right-click context menu for the logo
 * Shows copy options and download functionality
 */
import Volume2 from "@lucide/astro/icons/volume-2";

export interface Props {
  class?: string;
}

const { class: className = "" } = Astro.props;
---

<div
  id="logo-context-wrapper"
  class={`relative dark cursor-context-menu ${className}`}
  data-logo-context
>
  <slot />

  <!-- Context Menu -->
  <div
    id="logo-context-menu"
    class="fixed mt-2 z-100 hidden min-w-[220px] rounded-md bg-popover px-4 py-2 shadow-xl ring-1 ring-border"
    data-context-menu
  >
    <!-- Pronunciation -->
    <div class="py-2 border-b border-border">
      <span class="text-[0.65rem] text-muted-foreground">Pronunciation</span>
      <button
        class="flex items-center gap-1.5 text-sm text-popover-foreground hover:text-muted-foreground transition-colors w-full"
        data-play-audio
      >
        <span>/ˈbɛər-ni/ </span>
        <Volume2 class="size-3.5 ml-auto text-muted-foreground" />
      </button>
      <audio id="bearnie-audio" src="/audios/bernie_voice.mp3" preload="none"
      ></audio>
    </div>

    <!-- Copy Options -->
    <div class="py-1 border-b border-border">
      <button
        class="flex w-full items-center justify-between py-1 text-xs text-popover-foreground rounded-lg hover:bg-accent transition-colors"
        data-copy-symbol
      >
        <span>Copy Symbol</span>
        <span class="text-[0.65rem] text-muted-foreground">svg</span>
      </button>
      <button
        class="flex w-full items-center justify-between py-1 text-xs text-popover-foreground rounded-lg hover:bg-accent transition-colors"
        data-copy-wordmark
      >
        <span>Copy Wordmark</span>
        <span class="text-[0.65rem] text-muted-foreground">svg</span>
      </button>
    </div>

    <!-- Download All -->
    <div class="pt-1">
      <button
        class="flex w-full items-center justify-between py-1 text-xs text-popover-foreground rounded-lg hover:bg-accent transition-colors"
        data-download-all
      >
        <span>Download all</span>
        <span class="text-[0.65rem] text-muted-foreground">zip</span>
      </button>
    </div>
  </div>
</div>

<script>
  // Initialize all logo context menus
  function initLogoContextMenus() {
    const wrappers = document.querySelectorAll("[data-logo-context]");

    wrappers.forEach((wrapper) => {
      if (wrapper.hasAttribute("data-initialized")) return;
      wrapper.setAttribute("data-initialized", "true");

      const menu = wrapper.querySelector("[data-context-menu]") as HTMLElement;
      const copySymbolBtn = wrapper.querySelector("[data-copy-symbol]");
      const copyWordmarkBtn = wrapper.querySelector("[data-copy-wordmark]");
      const playAudioBtn = wrapper.querySelector("[data-play-audio]");
      const audioElement = wrapper.querySelector(
        "#bearnie-audio",
      ) as HTMLAudioElement;
      const downloadBtn = wrapper.querySelector("[data-download-all]");

      if (!menu) return;

      // Right-click handler
      wrapper.addEventListener("contextmenu", (e) => {
        e.preventDefault();

        // Close any other open menus
        document.querySelectorAll("[data-context-menu]").forEach((m) => {
          if (m !== menu) m.classList.add("hidden");
        });

        // Get the wrapper (logo) position
        const wrapperRect = wrapper.getBoundingClientRect();

        // Show menu off-screen first to measure it
        menu.style.visibility = "hidden";
        menu.style.left = "0px";
        menu.style.top = "0px";
        menu.classList.remove("hidden");

        // Get actual menu dimensions
        const menuRect = menu.getBoundingClientRect();
        const menuWidth = menuRect.width;
        const menuHeight = menuRect.height;

        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;

        // Position below the logo, aligned to its left edge
        let posX = wrapperRect.left;
        let posY = wrapperRect.bottom + 8;

        // Adjust if menu would go off right edge
        if (posX + menuWidth > viewportWidth - 16) {
          posX = viewportWidth - menuWidth - 16;
        }

        // Adjust if menu would go off bottom - show above instead
        if (posY + menuHeight > viewportHeight - 16) {
          posY = wrapperRect.top - menuHeight - 8;
        }

        // Ensure menu doesn't go off left or top
        posX = Math.max(16, posX);
        posY = Math.max(16, posY);

        menu.style.left = `${posX}px`;
        menu.style.top = `${posY}px`;
        menu.style.visibility = "visible";
      });

      // Close menu when clicking elsewhere
      document.addEventListener("click", (e) => {
        if (!menu.contains(e.target as Node)) {
          menu.classList.add("hidden");
        }
      });

      // Close on escape
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          menu.classList.add("hidden");
        }
      });

      // Copy Symbol SVG
      copySymbolBtn?.addEventListener("click", async () => {
        try {
          const response = await fetch("/images/logos/symbol.svg");
          const svgText = await response.text();
          await navigator.clipboard.writeText(svgText);
          showFeedback(copySymbolBtn as HTMLElement, "Copied!");
        } catch (err) {
          console.error("Failed to copy symbol:", err);
          showFeedback(copySymbolBtn as HTMLElement, "Failed");
        }
      });

      // Copy Wordmark SVG
      copyWordmarkBtn?.addEventListener("click", async () => {
        try {
          const response = await fetch("/images/logos/wordmark.svg");
          const svgText = await response.text();
          await navigator.clipboard.writeText(svgText);
          showFeedback(copyWordmarkBtn as HTMLElement, "Copied!");
        } catch (err) {
          console.error("Failed to copy wordmark:", err);
          showFeedback(copyWordmarkBtn as HTMLElement, "Failed");
        }
      });

      // Play pronunciation audio
      playAudioBtn?.addEventListener("click", () => {
        if (audioElement) {
          audioElement.currentTime = 0;
          audioElement.play();
          showFeedback(playAudioBtn as HTMLElement, "Playing...");
        }
      });

      // Download all as ZIP
      downloadBtn?.addEventListener("click", async () => {
        try {
          // Dynamically import JSZip
          const JSZip = (await import("jszip")).default;
          const zip = new JSZip();

          // Fetch all assets
          const [symbolRes, wordmarkRes] = await Promise.all([
            fetch("/images/logos/symbol.svg"),
            fetch("/images/logos/wordmark.svg"),
          ]);

          const [symbolSvg, wordmarkSvg] = await Promise.all([
            symbolRes.text(),
            wordmarkRes.text(),
          ]);

          // Add files to zip
          zip.file("symbol.svg", symbolSvg);
          zip.file("wordmark.svg", wordmarkSvg);

          // Generate and download zip
          const blob = await zip.generateAsync({ type: "blob" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "bearnie-brand-assets.zip";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          showFeedback(downloadBtn as HTMLElement, "Downloaded!");
        } catch (err) {
          console.error("Failed to create zip:", err);
          showFeedback(downloadBtn as HTMLElement, "Failed");
        }
      });
    });
  }

  // Show temporary feedback on button
  function showFeedback(btn: HTMLElement, message: string) {
    const originalText =
      btn.querySelector("span:first-child")?.textContent || "";
    const span = btn.querySelector("span:first-child");
    if (span) {
      span.textContent = message;
      setTimeout(() => {
        span.textContent = originalText;
      }, 1500);
    }
  }

  // Initialize on load and after view transitions
  initLogoContextMenus();
  document.addEventListener("astro:after-swap", initLogoContextMenus);
</script>
