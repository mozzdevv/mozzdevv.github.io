---
import { cn } from "@/utils/cn";
import CodeBlock from "@/components/docs/CodeBlock.astro";
import Copy from "@lucide/astro/icons/copy";
import Check from "@lucide/astro/icons/check";

export interface Tab {
  id: string;
  label: string;
  code: string;
  lang?: "json" | "bash" | "typescript" | "astro";
  description?: string;
  instructions?: string[];
}

export interface Props {
  tabs: Tab[];
  class?: string;
}

const { tabs, class: className } = Astro.props;

const id = `docs-tabs-${Math.random().toString(36).substring(2, 9)}`;
---

<div class={cn("not-prose w-full", className)} data-docs-tabs={id}>
  <!-- Tab buttons -->
  <div class="flex items-center gap-1 flex-wrap">
    {
      tabs.map((tab, index) => (
        <button
          type="button"
          class="px-3 py-1.5 text-sm font-medium text-muted-foreground hover:text-foreground data-[active]:text-foreground data-[active]:bg-muted rounded-md transition-colors"
          data-docs-tab={tab.id}
          data-active={index === 0 ? "" : undefined}
        >
          {tab.label}
        </button>
      ))
    }
  </div>

  <!-- Tab panels -->
  <div class="mt-2">
    {
      tabs.map((tab, index) => (
        <div class={index === 0 ? "" : "hidden"} data-docs-panel={tab.id}>
          <div class="border border-border rounded-lg overflow-hidden">
            <div class="flex items-center justify-between px-4 py-2 border-b border-border bg-background">
              {tab.description && (
                <p class="text-sm text-muted-foreground">{tab.description}</p>
              )}
              {!tab.description && <span />}
              <button
                type="button"
                class="flex items-center justify-center p-1.5 text-muted-foreground hover:text-foreground rounded-md transition-colors shrink-0"
                data-copy-button
                title="Copy code"
              >
                <Copy size={14} data-copy-icon />
                <Check size={14} class="hidden" data-check-icon />
              </button>
            </div>
            <span class="sr-only" data-code-content>
              {tab.code}
            </span>
            <CodeBlock
              code={tab.code}
              lang={tab.lang || "json"}
              class="rounded-none bg-transparent"
              showCopy={false}
            />
          </div>

          {tab.instructions && tab.instructions.length > 0 && (
            <ul class="text-sm text-muted-foreground mt-4 space-y-1 list-disc list-inside">
              {tab.instructions.map((instruction) => (
                <li>{instruction}</li>
              ))}
            </ul>
          )}
        </div>
      ))
    }
  </div>
</div>

<script>
  function initDocsTabs() {
    document.querySelectorAll("[data-docs-tabs]").forEach((container) => {
      if (container.hasAttribute("data-initialized")) return;
      container.setAttribute("data-initialized", "true");

      const tabs = container.querySelectorAll("[data-docs-tab]");
      const panels = container.querySelectorAll("[data-docs-panel]");
      const copyButtons = container.querySelectorAll("[data-copy-button]");

      function setActiveTab(activeValue: string) {
        tabs.forEach((tab) => {
          if (tab.getAttribute("data-docs-tab") === activeValue) {
            tab.setAttribute("data-active", "");
          } else {
            tab.removeAttribute("data-active");
          }
        });

        panels.forEach((panel) => {
          if (panel.getAttribute("data-docs-panel") === activeValue) {
            panel.classList.remove("hidden");
          } else {
            panel.classList.add("hidden");
          }
        });
      }

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          const value = tab.getAttribute("data-docs-tab");
          if (value) setActiveTab(value);
        });
      });

      // Copy functionality
      copyButtons.forEach((copyButton) => {
        const copyIcon = copyButton.querySelector("[data-copy-icon]");
        const checkIcon = copyButton.querySelector("[data-check-icon]");

        copyButton.addEventListener("click", async () => {
          const panel = copyButton.closest("[data-docs-panel]");
          const codeContent = panel?.querySelector("[data-code-content]");
          const code = codeContent?.textContent || "";

          try {
            await navigator.clipboard.writeText(code);
            copyIcon?.classList.add("hidden");
            checkIcon?.classList.remove("hidden");
            setTimeout(() => {
              copyIcon?.classList.remove("hidden");
              checkIcon?.classList.add("hidden");
            }, 2000);
          } catch (err) {
            console.error("Failed to copy:", err);
          }
        });
      });
    });
  }

  initDocsTabs();
  document.addEventListener("astro:page-load", initDocsTabs);
</script>
