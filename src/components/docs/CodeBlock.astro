---
/**
 * CodeBlock - Syntax highlighted code block with copy button
 */
import { Code } from "astro:components";
import { cn } from "@/utils/cn";
import Copy from "@lucide/astro/icons/copy";
import Check from "@lucide/astro/icons/check";
import { shikiLightTheme, shikiDarkTheme } from "@/config/shiki-themes";

export interface Props {
  code: string;
  lang?:
    | "astro"
    | "typescript"
    | "javascript"
    | "bash"
    | "css"
    | "html"
    | "json"
    | "tsx"
    | "jsx"
    | "plaintext";
  class?: string;
  showCopy?: boolean;
}

const { code, lang = "astro", class: className, showCopy = true } = Astro.props;

function normalizeCode(value: string) {
  const normalized = value.replace(/\r\n?/g, "\n").replace(/\t/g, "  ");
  const trimmed = normalized.replace(/^\n+/, "").replace(/\s+$/, "");
  const lines = trimmed.split("\n");
  const indents = lines
    .filter((line) => line.trim().length > 0)
    .map((line) => line.match(/^\s+/)?.[0].length ?? 0);
  const minIndent = indents.length ? Math.min(...indents) : 0;
  return lines
    .map((line) => line.slice(minIndent).replace(/\s+$/g, ""))
    .join("\n");
}

const normalizedCode = normalizeCode(code);
---

<div
  class={cn(
    "relative w-full max-w-full min-w-0 rounded-lg bg-muted/50 overflow-hidden group",
    className,
  )}
  data-codeblock
>
  <div
    class="w-full max-w-full min-w-0 overflow-x-auto [&_pre]:m-0 [&_pre]:rounded-none [&_pre]:p-4 [&_pre]:pr-12 [&_pre]:font-mono [&_pre]:leading-6 [&_pre]:whitespace-pre [&_pre]:min-w-0 [&_pre]:w-full [&_pre]:text-xs scrollbar-hide"
  >
    <Code
      code={normalizedCode}
      lang={lang}
      themes={{ light: shikiLightTheme, dark: shikiDarkTheme }}
      defaultColor={false}
      class="font-mono leading-6 whitespace-pre text-xs scrollbar-hide focus:ring-none"
    />
  </div>

  {
    showCopy && (
      <button
        type="button"
        class="absolute top-3 right-3 p-1.5 rounded-md text-muted-foreground hover:text-foreground hover:bg-muted/80 transition-colors"
        data-copy-button
        title="Copy to clipboard"
      >
        <Copy size={16} data-copy-icon />
        <Check size={16} class="hidden" data-check-icon />
      </button>
    )
  }

  <div class="hidden" data-code-content>{normalizedCode}</div>
</div>

<script>
  // Initialize all code blocks - runs once globally
  function initCodeBlocks() {
    document.querySelectorAll("[data-codeblock]").forEach((container) => {
      if (container.hasAttribute("data-initialized")) return;
      container.setAttribute("data-initialized", "true");

      const copyButton = container.querySelector("[data-copy-button]");
      const codeContent = container.querySelector("[data-code-content]");
      const copyIcon = container.querySelector("[data-copy-icon]");
      const checkIcon = container.querySelector("[data-check-icon]");

      copyButton?.addEventListener("click", async () => {
        const code = codeContent?.textContent || "";
        try {
          await navigator.clipboard.writeText(code);
          copyIcon?.classList.add("hidden");
          checkIcon?.classList.remove("hidden");
          setTimeout(() => {
            copyIcon?.classList.remove("hidden");
            checkIcon?.classList.add("hidden");
          }, 2000);
        } catch (err) {
          console.error("Failed to copy:", err);
        }
      });
    });
  }

  initCodeBlocks();
  document.addEventListener("astro:page-load", initCodeBlocks);
</script>
