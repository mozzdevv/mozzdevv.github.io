---
import { getCollection } from "astro:content";
import Search from "@lucide/astro/icons/search";
import Command from "@lucide/astro/icons/command";

// Get all docs content
const components = await Promise.all(
  (await getCollection("components")).map(async (component) => ({
    title: component.data.title,
    description: component.data.description,
    slug: component.slug,
    type: "component",
  })),
);

// Get docs pages from collection
const docs = await Promise.all(
  (await getCollection("docs")).map(async (doc) => ({
    title: doc.data.title,
    description: doc.data.description,
    slug: doc.slug === "introduction" ? "" : doc.slug,
    type: "doc",
  })),
);

const allDocs = [...docs, ...components];
---

<button
  type="button"
  class="inline-flex items-center gap-1.5 px-2.5 py-1.5 h-7 text-sm text-muted-foreground bg-background border border-border rounded-sm hover:bg-muted transition-colors"
  data-docs-search-trigger
  aria-label="Search documentation"
>
  <Search size={14} />
  <kbd class="inline-flex items-center gap-0.5 text-muted-foreground">
    <Command size={12} /><span class="text-sm font-medium">K</span>
  </kbd>
</button>

<script is:inline define:vars={{ allDocs }}>
  (function () {
    // Wait for DOM
    function init() {
      // Only create the modal once
      if (document.getElementById("docs-search-modal")) {
        // Modal exists, just attach click handlers to any new triggers
        document
          .querySelectorAll("[data-docs-search-trigger]")
          .forEach(function (trigger) {
            if (!trigger.hasAttribute("data-initialized")) {
              trigger.setAttribute("data-initialized", "true");
              trigger.addEventListener("click", function () {
                var modal = document.getElementById("docs-search-modal");
                if (modal) {
                  modal.classList.remove("hidden");
                  document.body.style.overflow = "hidden";
                  var input = modal.querySelector("[data-search-input]");
                  setTimeout(function () {
                    if (input) input.focus();
                  }, 50);
                }
              });
            }
          });
        return;
      }

      // Create global modal
      var modal = document.createElement("div");
      modal.id = "docs-search-modal";
      modal.className = "fixed inset-0 z-[100] hidden";
      modal.setAttribute("role", "dialog");
      modal.setAttribute("aria-modal", "true");
      modal.innerHTML =
        '<div class="absolute inset-0 bg-overlay/10 backdrop-blur-sm" data-search-backdrop></div><div class="relative flex items-start justify-center pt-[20vh] px-4"><div class="w-full max-w-md bg-popover border border-border rounded-xl shadow-xl overflow-hidden"><div class="flex items-center gap-3 px-3 border-b border-border"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-muted-foreground shrink-0"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg><input type="text" placeholder="Search documentation..." class="flex-1 h-12 text-sm bg-transparent border-0 outline-none focus:outline-none focus:ring-0 shadow-none placeholder:text-muted-foreground text-foreground" data-search-input /><button type="button" class="text-[10px] text-muted-foreground px-1.5 py-1 rounded border border-border bg-muted hover:bg-muted/80" data-search-close>ESC</button></div><div class="max-h-[50vh] overflow-y-auto" data-search-results><div class="py-12 text-sm text-muted-foreground text-center" data-search-hint>Type to search...</div><div class="py-12 text-sm text-muted-foreground text-center hidden" data-search-empty>No results found</div></div></div></div>';
      document.body.appendChild(modal);

      var backdrop = modal.querySelector("[data-search-backdrop]");
      var input = modal.querySelector("[data-search-input]");
      var results = modal.querySelector("[data-search-results]");
      var emptyState = modal.querySelector("[data-search-empty]");
      var hint = modal.querySelector("[data-search-hint]");
      var closeBtn = modal.querySelector("[data-search-close]");

      function search(query) {
        if (!query.trim()) return [];
        var q = query.toLowerCase();
        return allDocs.filter(function (doc) {
          return (
            doc.title.toLowerCase().includes(q) ||
            doc.description.toLowerCase().includes(q)
          );
        });
      }

      function getHref(doc) {
        if (doc.type === "component") {
          return "/docs/components/" + doc.slug;
        }
        return doc.slug ? "/docs/" + doc.slug : "/docs";
      }

      var selectedIndex = -1;

      function updateSelection() {
        var items = results.querySelectorAll("[data-result-item]");
        items.forEach(function (item, index) {
          if (index === selectedIndex) {
            item.classList.add("bg-muted");
            item.scrollIntoView({ block: "nearest" });
          } else {
            item.classList.remove("bg-muted");
          }
        });
      }

      function renderResults(docs) {
        var items = results.querySelectorAll("[data-result-item]");
        items.forEach(function (item) {
          item.remove();
        });

        selectedIndex = -1;

        if (!input.value.trim()) {
          emptyState.classList.add("hidden");
          hint.classList.remove("hidden");
          return;
        }

        hint.classList.add("hidden");

        if (docs.length === 0) {
          emptyState.classList.remove("hidden");
          return;
        }

        emptyState.classList.add("hidden");

        docs.forEach(function (doc, index) {
          var item = document.createElement("a");
          item.setAttribute("data-result-item", "");
          item.setAttribute("data-result-index", index);
          item.href = getHref(doc);
          item.className =
            "flex flex-col gap-0.5 px-4 py-3 hover:bg-muted transition-colors cursor-pointer border-b border-border last:border-0";
          item.innerHTML =
            '<span class="text-sm font-medium text-foreground">' +
            doc.title +
            '</span><span class="text-xs text-muted-foreground line-clamp-1">' +
            doc.description +
            "</span>";
          item.addEventListener("click", closeModal);
          item.addEventListener("mouseenter", function () {
            selectedIndex = index;
            updateSelection();
          });
          results.appendChild(item);
        });
      }

      function openModal() {
        modal.classList.remove("hidden");
        document.body.style.overflow = "hidden";
        selectedIndex = -1;
        setTimeout(function () {
          input.focus();
        }, 50);
      }

      function closeModal() {
        modal.classList.add("hidden");
        document.body.style.overflow = "";
        input.value = "";
        selectedIndex = -1;
        renderResults([]);
      }

      // Attach to all trigger buttons
      document
        .querySelectorAll("[data-docs-search-trigger]")
        .forEach(function (trigger) {
          trigger.setAttribute("data-initialized", "true");
          trigger.addEventListener("click", openModal);
        });

      if (closeBtn) closeBtn.addEventListener("click", closeModal);

      // Close when clicking outside the modal content (on backdrop or empty space)
      modal.addEventListener("click", function (e) {
        // Check if click is directly on the modal or backdrop (not on the dialog content)
        var dialogContent = modal.querySelector(".max-w-md");
        if (dialogContent && !dialogContent.contains(e.target)) {
          closeModal();
        }
      });

      input.addEventListener("input", function (e) {
        var docs = search(e.target.value);
        renderResults(docs);
      });

      // Keyboard navigation within search results
      input.addEventListener("keydown", function (e) {
        var items = results.querySelectorAll("[data-result-item]");
        var itemCount = items.length;

        if (itemCount === 0) return;

        if (e.key === "ArrowDown") {
          e.preventDefault();
          selectedIndex = selectedIndex < itemCount - 1 ? selectedIndex + 1 : 0;
          updateSelection();
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          selectedIndex = selectedIndex > 0 ? selectedIndex - 1 : itemCount - 1;
          updateSelection();
        } else if (e.key === "Enter" && selectedIndex >= 0) {
          e.preventDefault();
          var selectedItem = items[selectedIndex];
          if (selectedItem) {
            closeModal();
            window.location.href = selectedItem.href;
          }
        }
      });

      // Global keyboard shortcuts
      document.addEventListener("keydown", function (e) {
        if ((e.metaKey || e.ctrlKey) && e.key === "k") {
          e.preventDefault();
          if (modal.classList.contains("hidden")) {
            openModal();
          } else {
            closeModal();
          }
        }
        if (e.key === "Escape" && !modal.classList.contains("hidden")) {
          closeModal();
        }
      });
    }

    // Run when DOM is ready
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  })();
</script>
