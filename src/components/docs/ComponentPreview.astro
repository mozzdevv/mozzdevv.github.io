---
import { cn } from "@/utils/cn";
import Copy from "@lucide/astro/icons/copy";
import Check from "@lucide/astro/icons/check";
import SquareTerminal from "@lucide/astro/icons/square-terminal";
import CodeBlock from "@/components/docs/CodeBlock.astro";
import Tooltip from "@/components/ui/tooltip/Tooltip.astro";
import TooltipTrigger from "@/components/ui/tooltip/TooltipTrigger.astro";
import TooltipContent from "@/components/ui/tooltip/TooltipContent.astro";

export interface Props {
  // For preview mode (preview/code tabs)
  code?: string;
  // Code to display in "Code" tab (if different from preview code)
  displayCode?: string;
  // For install mode - component name to generate CLI commands
  component?: string;
  // Full width preview without padding/max-width (for sidebars, etc.)
  fullWidth?: boolean;
  class?: string;
}

const {
  code,
  displayCode,
  component,
  fullWidth = false,
  class: className,
} = Astro.props;

// Determine mode based on props
const isInstallMode = !!component;

// Check if code is provided via named slot
let codeFromSlot: string | null = null;
if (Astro.slots.has("code")) {
  const renderedSlot = await Astro.slots.render("code");
  // Extract text content from the rendered <pre><code>...</code></pre>
  // Shiki wraps code in <span> elements for syntax highlighting, so we need to strip all HTML
  const codeMatch = renderedSlot.match(/<code[^>]*>([\s\S]*?)<\/code>/);
  if (codeMatch) {
    // Strip all HTML tags (Shiki adds <span> elements for highlighting)
    let plainText = codeMatch[1].replace(/<[^>]*>/g, "");
    // Decode HTML entities
    codeFromSlot = plainText
      .replace(/&lt;/g, "<")
      .replace(/&gt;/g, ">")
      .replace(/&amp;/g, "&")
      .replace(/&quot;/g, '"')
      .replace(/&#39;/g, "'")
      .replace(/&#x27;/g, "'");
  }
}

// Generate a unique ID for this preview
const id = `preview-${Math.random().toString(36).substring(2, 9)}`;

// Package manager commands
const packageManagers = component
  ? [
      { id: "npx", label: "npx", command: `npx bearnie add ${component}` },
      { id: "bun", label: "bun", command: `bunx bearnie add ${component}` },
      {
        id: "pnpm",
        label: "pnpm",
        command: `pnpm dlx bearnie add ${component}`,
      },
      {
        id: "yarn",
        label: "yarn",
        command: `yarn dlx bearnie add ${component}`,
      },
    ]
  : [];

// Basic normalization - remove common leading whitespace
function normalizeCode(value: string) {
  const normalized = value.replace(/\r\n?/g, "\n").replace(/\t/g, "  ");
  const trimmed = normalized.replace(/^\n+/, "").replace(/\s+$/, "");
  const lines = trimmed.split("\n");
  const indents = lines
    .filter((line) => line.trim().length > 0)
    .map((line) => line.match(/^\s+/)?.[0].length ?? 0);
  const minIndent = indents.length ? Math.min(...indents) : 0;
  return lines
    .map((line) => line.slice(minIndent).replace(/\s+$/g, ""))
    .join("\n");
}

// Priority: displayCode > codeFromSlot > code prop
const normalizedCode = displayCode
  ? normalizeCode(displayCode)
  : codeFromSlot
    ? normalizeCode(codeFromSlot)
    : code
      ? normalizeCode(code)
      : "";
---

<div
  class={cn("not-prose w-full max-w-full min-w-0", className)}
  data-component-preview={id}
  data-mode={isInstallMode ? "install" : "preview"}
>
  {
    !isInstallMode && (
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <button
            type="button"
            class="px-3 py-1.5 text-sm font-medium text-muted-foreground hover:text-foreground data-active:text-foreground data-active:bg-muted rounded-md transition-colors"
            data-preview-tab="preview"
            data-active
          >
            Preview
          </button>
          <button
            type="button"
            class="px-3 py-1.5 text-sm font-medium text-muted-foreground hover:text-foreground data-active:text-foreground data-active:bg-muted rounded-md transition-colors"
            data-preview-tab="code"
          >
            Code
          </button>
        </div>

        <Tooltip>
          <TooltipTrigger>
            <button
              type="button"
              class="flex items-center justify-center p-2 text-muted-foreground hover:text-foreground rounded-lg transition-colors"
              data-copy-button
            >
              <Copy size={16} data-copy-icon />
              <Check size={16} class="hidden" data-check-icon />
            </button>
          </TooltipTrigger>
          <TooltipContent class="dark text-xs px-2 py-1 shadow-none">
            Copy to clipboard
          </TooltipContent>
        </Tooltip>
      </div>
    )
  }

  <div class={isInstallMode ? "" : "mt-2"}>
    {
      isInstallMode ? (
        <div class="border rounded-lg overflow-hidden">
          <div class="flex items-center justify-between px-4 py-2 border-b bg-background">
            <div class="flex items-center gap-2">
              <SquareTerminal class="size-4 text-muted-foreground" />
              {packageManagers.map((pm, index) => (
                <button
                  type="button"
                  class="px-2.5 py-1 text-xs font-medium text-muted-foreground hover:text-foreground data-active:text-foreground data-active:bg-muted rounded-md transition-colors"
                  data-pm-tab={pm.id}
                  data-active={index === 0 ? "" : undefined}
                >
                  {pm.label}
                </button>
              ))}
            </div>
            <Tooltip>
              <TooltipTrigger>
                <button
                  type="button"
                  class="flex items-center justify-center p-1.5 text-muted-foreground hover:text-foreground rounded-md transition-colors"
                  data-copy-button
                >
                  <Copy size={14} data-copy-icon />
                  <Check size={14} class="hidden" data-check-icon />
                </button>
              </TooltipTrigger>
              <TooltipContent class="dark text-xs px-2 py-1 shadow-none">
                Copy to clipboard
              </TooltipContent>
            </Tooltip>
          </div>

          {packageManagers.map((pm, index) => (
            <div class={index === 0 ? "" : "hidden"} data-pm-panel={pm.id}>
              <span class="sr-only" data-code-content>
                {pm.command}
              </span>
              <CodeBlock
                code={pm.command}
                lang="bash"
                class="rounded-none border-0 bg-transparent"
                showCopy={false}
              />
            </div>
          ))}
        </div>
      ) : (
        <>
          <div
            class={cn(
              "min-h-30 rounded-lg overflow-x-auto lg:overflow-visible",
              fullWidth ? "p-0" : "p-8 lg:p-20 border",
            )}
            data-preview-panel="preview"
          >
            <div
              class={cn(
                "flex items-center justify-center w-max min-w-full",
                !fullWidth && "max-w-lg mx-auto",
              )}
            >
              <slot />
            </div>
          </div>

          <div
            class="hidden  rounded-lg overflow-hidden max-h-[400px] overflow-y-auto w-full max-w-full min-w-0 scrollbar-hide bg-muted/50"
            data-preview-panel="code"
          >
            <span class="sr-only" data-code-content>
              {normalizedCode}
            </span>
            <CodeBlock
              code={normalizedCode}
              lang="astro"
              class="rounded-none border-0 bg-transparent font-medium"
              showCopy={false}
            />
          </div>
        </>
      )
    }
  </div>
</div>

<script>
  function initComponentPreviews() {
    document
      .querySelectorAll("[data-component-preview]")
      .forEach((container) => {
        if (container.hasAttribute("data-initialized")) return;
        container.setAttribute("data-initialized", "true");

        const tabs = container.querySelectorAll("[data-preview-tab]");
        const panels = container.querySelectorAll("[data-preview-panel]");
        const pmTabs = container.querySelectorAll("[data-pm-tab]");
        const pmPanels = container.querySelectorAll("[data-pm-panel]");
        const copyButtons = container.querySelectorAll("[data-copy-button]");

        // Main tab switching (CLI/Manual or Preview/Code)
        function setActiveTab(activeValue: string) {
          tabs.forEach((tab) => {
            if (tab.getAttribute("data-preview-tab") === activeValue) {
              tab.setAttribute("data-active", "");
            } else {
              tab.removeAttribute("data-active");
            }
          });

          panels.forEach((panel) => {
            if (panel.getAttribute("data-preview-panel") === activeValue) {
              panel.classList.remove("hidden");
            } else {
              panel.classList.add("hidden");
            }
          });
        }

        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            const value = tab.getAttribute("data-preview-tab");
            if (value) setActiveTab(value);
          });
        });

        // Package manager sub-tab switching
        function setActivePmTab(activeValue: string) {
          pmTabs.forEach((tab) => {
            if (tab.getAttribute("data-pm-tab") === activeValue) {
              tab.setAttribute("data-active", "");
            } else {
              tab.removeAttribute("data-active");
            }
          });

          pmPanels.forEach((panel) => {
            if (panel.getAttribute("data-pm-panel") === activeValue) {
              panel.classList.remove("hidden");
            } else {
              panel.classList.add("hidden");
            }
          });
        }

        pmTabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            const value = tab.getAttribute("data-pm-tab");
            if (value) setActivePmTab(value);
          });
        });

        // Copy functionality
        copyButtons.forEach((copyButton) => {
          const copyIcon = copyButton.querySelector("[data-copy-icon]");
          const checkIcon = copyButton.querySelector("[data-check-icon]");

          copyButton.addEventListener("click", async () => {
            // Find the visible code content relative to this button
            const panel = copyButton.closest("[data-preview-panel]");
            let codeContent: Element | null = null;

            if (panel) {
              // Check for visible PM panel first
              const visiblePmPanel = panel.querySelector(
                "[data-pm-panel]:not(.hidden)",
              );
              if (visiblePmPanel) {
                codeContent = visiblePmPanel.querySelector(
                  "[data-code-content]",
                );
              } else {
                codeContent = panel.querySelector("[data-code-content]");
              }
            } else {
              // Fallback for code panel in preview mode
              const activePanel = container.querySelector(
                "[data-preview-panel]:not(.hidden)",
              );
              codeContent =
                activePanel?.querySelector("[data-code-content]") || null;
            }

            const code = codeContent?.textContent || "";

            try {
              await navigator.clipboard.writeText(code);
              copyIcon?.classList.add("hidden");
              checkIcon?.classList.remove("hidden");
              setTimeout(() => {
                copyIcon?.classList.remove("hidden");
                checkIcon?.classList.add("hidden");
              }, 2000);
            } catch (err) {
              console.error("Failed to copy:", err);
            }
          });
        });
      });
  }

  initComponentPreviews();
  document.addEventListener("astro:page-load", initComponentPreviews);
</script>
