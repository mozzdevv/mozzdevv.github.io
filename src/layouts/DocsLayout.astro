---
import { AstroSeo } from "@astrolib/seo";
import { getCollection } from "astro:content";
import { siteConfig } from "@/config/site";
// Fundations
import BaseLayout from "./BaseLayout.astro";
import CopyPageButton from "@/components/fundations/elements/CopyPageButton.astro";
import Text from "@/components/fundations/elements/Text.astro";
// Components
import Badge from "@/components/ui/badge/Badge.astro";
import Kbd from "@/components/ui/kbd/Kbd.astro";
import DocsMobileNavigation from "@/components/global/navigation/DocsMobileNavigation.astro";
import Navigation from "@/components/global/navigation/Navigation.astro";
import SidebarNav from "@/components/global/navigation/SidebarNav.astro";
import TableOfContents from "@/components/global/navigation/TableOfContents.astro";
// Docs
import DocsPagination from "@/components/docs/DocsPagination.astro";
import PaginationArrows from "@/components/docs/PaginationArrows.astro";
// Icons
import ArrowUp from "@lucide/astro/icons/arrow-up";
import ArrowDown from "@lucide/astro/icons/arrow-down";
import ArrowLeft from "@lucide/astro/icons/arrow-left";
import ArrowRight from "@lucide/astro/icons/arrow-right";

// Fetch content collections for taglines
const docsEntries = await getCollection("docs");
const componentEntries = await getCollection("components");

// Create a map of href -> tagline from content
const taglineMap = new Map<string, string>();

// Add docs entries
docsEntries.forEach((entry) => {
  const href = entry.slug === "introduction" ? "/docs" : `/docs/${entry.slug}`;
  taglineMap.set(href, entry.data.tagline || entry.data.description);
});

// Add component entries
componentEntries.forEach((entry) => {
  const href = `/docs/components/${entry.slug}`;
  taglineMap.set(href, entry.data.tagline || entry.data.description);
});

export interface Props {
  title: string;
  description?: string;
  keywords?: string[];
  status?: "stable" | "beta" | "alpha";
  showHeader?: boolean;
}
const {
  title,
  description,
  keywords = [],
  status = "stable",
  showHeader = true,
} = Astro.props;
const currentPath = Astro.url.pathname;
const canonical = `${siteConfig.url}${currentPath || "/"}`;
// Sort docs by order, then alphabetically
const sortedDocs = docsEntries.sort((a, b) => {
  const orderA = a.data.order ?? 999;
  const orderB = b.data.order ?? 999;
  if (orderA !== orderB) return orderA - orderB;
  return a.data.title.localeCompare(b.data.title);
});

// Sort components alphabetically
const sortedComponents = componentEntries.sort((a, b) =>
  a.data.title.localeCompare(b.data.title),
);

const navigation = [
  {
    title: "Get started",
    icon: "sparkles" as const,
    items: [
      ...sortedDocs.map((entry) => ({
        title: entry.data.title,
        href: entry.slug === "introduction" ? "/docs" : `/docs/${entry.slug}`,
      })),
      { title: "Create theme", href: "/create-bearnie-theme" },
      { title: "Code image", href: "/code-image" },
    ],
  },
  {
    title: "Components",
    icon: "component" as const,
    items: sortedComponents.map((entry) => ({
      title: entry.data.title,
      href: `/docs/components/${entry.slug}`,
    })),
  },
];

// Flatten navigation for pagination
const allPages = navigation.flatMap((section) => section.items);
const currentIndex = allPages.findIndex(
  (page) =>
    page.href === currentPath || page.href === currentPath.replace(/\/$/, ""),
);
const prevPage = currentIndex > 0 ? allPages[currentIndex - 1] : null;
const nextPage =
  currentIndex < allPages.length - 1 ? allPages[currentIndex + 1] : null;

// Get taglines for prev/next pages
const prevTagline = prevPage ? taglineMap.get(prevPage.href) : null;
const nextTagline = nextPage ? taglineMap.get(nextPage.href) : null;

// Show pagination on all docs pages
const isDocsPage = currentPath.startsWith("/docs");
---

<AstroSeo
  title={`${title} | ${siteConfig.name}`}
  description={description || `Learn how to use the ${title} component.`}
  canonical={canonical}
  openGraph={{
    url: canonical,
    title: `${title} | ${siteConfig.name}`,
    description: description || `Learn how to use the ${title} component.`,
    site_name: siteConfig.name,
    type: "article",
    locale: "en_US",
    images: [
      {
        url: siteConfig.ogImage,
        width: 1200,
        height: 630,
        alt: `${siteConfig.name} Open Graph image`,
        type: "image/jpeg",
      },
    ],
  }}
  twitter={{
    cardType: "summary_large_image",
    site: siteConfig.author.twitter,
    handle: siteConfig.author.twitter,
  }}
/>
<BaseLayout
  showFooter={false}
  showNavigation={false}
  bodyClass="bg-muted"
  structuredData={{
    "@context": "https://schema.org",
    "@type": "TechArticle",
    headline: title,
    description:
      description || `${title} - Bearnie component library documentation`,
    url: canonical,
    author: {
      "@type": "Organization",
      name: siteConfig.name,
      url: siteConfig.url,
    },
    publisher: {
      "@type": "Organization",
      name: siteConfig.name,
      url: siteConfig.url,
      logo: {
        "@type": "ImageObject",
        url: `${siteConfig.url}/images/logos/symbol.svg`,
      },
    },
    isPartOf: {
      "@type": "WebSite",
      name: siteConfig.name,
      url: siteConfig.url,
    },
    keywords: keywords.length > 0 ? keywords.join(", ") : undefined,
  }}
>
  <div class="fixed inset-0 flex flex-col 2xl:max-w-350 mx-auto bg-muted">
    <Navigation variant="docs" />
    <DocsMobileNavigation navigation={navigation} currentPath={currentPath} />

    <div
      class="relative flex flex-1 min-h-0 bg-background rounded-lg lg:rounded-2xl overflow-hidden m-2 lg:m-3 lg:mt-0 mt-0"
    >
      <!-- Desktop Sidebar -->
      <div class="hidden md:block lg:w-62 shrink-0 relative">
        <aside
          id="sidebar-scroll-container"
          class="h-full overflow-y-auto scrollbar-overlay"
        >
          <SidebarNav navigation={navigation} currentPath={currentPath} />
        </aside>
        <!-- Bottom blur fade -->
        <div
          class="pointer-events-none absolute inset-x-0 bottom-0 h-16 bg-linear-to-t from-background via-background/80 to-transparent"
        >
        </div>
      </div>
      <!-- Main Content + TOC wrapped in box -->
      <div
        class="flex-1 min-w-0 flex overflow-y-auto overflow-x-hidden scrollbar-styled"
      >
        <div class="flex-1 min-w-0">
          <div class="max-w-3xl 2xl:max-w-5xl mx-auto">
            <!-- Main Content -->
            <main class="py-12 px-8 lg:px-12">
              <div class="mx-auto min-w-0" id="docs-content">
                {
                  showHeader && (
                    <div class="space-y-1">
                      <div class="flex items-center justify-between gap-4">
                        <div class="flex items-center gap-2">
                          <Text
                            tag="h1"
                            variant="displayXS"
                            class=" font-semibold tracking-tight"
                          >
                            {title}
                          </Text>
                          {status !== "stable" && (
                            <Badge
                              variant={
                                status === "beta" ? "secondary" : "outline"
                              }
                            >
                              {status}
                            </Badge>
                          )}
                        </div>

                        {/* Copy Page + Pagination */}
                        <div class="flex items-center gap-2">
                          <CopyPageButton />
                          {isDocsPage && (
                            <PaginationArrows
                              prevPage={prevPage}
                              nextPage={nextPage}
                            />
                          )}
                        </div>
                      </div>
                      {description && (
                        <Text
                          tag="p"
                          variant="textBase"
                          class="text-muted-foreground text-pretty lg:text-balance mt-4"
                        >
                          {description}
                        </Text>
                      )}
                    </div>
                  )
                }
                <article class="mt-12 space-y-12" id="docs-article-content">
                  <slot />
                </article>

                {/* Pagination */}
                {
                  isDocsPage && (
                    <DocsPagination
                      prevPage={prevPage}
                      nextPage={nextPage}
                      nextTagline={nextTagline}
                    />
                  )
                }
              </div>
            </main>
          </div>
        </div>
        <!-- Right Sidebar - Table of Contents -->
        <TableOfContents />
      </div>

      <!-- Border overlay - sits on top of scrollbars -->
      <div
        class="pointer-events-none absolute inset-0 rounded-lg lg:rounded-2xl ring-1 ring-inset ring-border"
      >
      </div>
    </div>
  </div>
  <script>
    // Mobile menu functionality
    function initMobileMenu() {
      const mobileMenuToggle = document.getElementById(
        "docs-mobile-menu-toggle",
      );
      const mobileMenuClose = document.getElementById("docs-mobile-menu-close");
      const mobileSidebar = document.getElementById("docs-mobile-sidebar");
      const mobileBackdrop = document.getElementById("docs-mobile-backdrop");

      if (!mobileMenuToggle || !mobileSidebar) return;
      if (mobileMenuToggle.hasAttribute("data-initialized")) return;
      mobileMenuToggle.setAttribute("data-initialized", "true");

      function openMobileMenu() {
        mobileSidebar?.classList.remove("-translate-x-full");
        mobileBackdrop?.classList.remove("opacity-0", "pointer-events-none");
        mobileBackdrop?.classList.add("opacity-100", "pointer-events-auto");
      }
      function closeMobileMenu() {
        mobileSidebar?.classList.add("-translate-x-full");
        mobileBackdrop?.classList.add("opacity-0", "pointer-events-none");
        mobileBackdrop?.classList.remove("opacity-100", "pointer-events-auto");
      }
      mobileMenuToggle.addEventListener("click", openMobileMenu);
      mobileMenuClose?.addEventListener("click", closeMobileMenu);
      mobileBackdrop?.addEventListener("click", closeMobileMenu);
      // Close on link click
      mobileSidebar.querySelectorAll("a").forEach((link) => {
        link.addEventListener("click", closeMobileMenu);
      });
      // Close on escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeMobileMenu();
      });
    }
    initMobileMenu();
    document.addEventListener("astro:page-load", initMobileMenu);

    // Keyboard navigation for docs pages
    function initKeyboardNav() {
      const container = document.getElementById("docs-content");
      if (!container) return;
      if (container.hasAttribute("data-nav-initialized")) return;
      container.setAttribute("data-nav-initialized", "true");

      const prevPageLink = document.querySelector<HTMLAnchorElement>(
        "[data-pagination-prev]",
      );
      const nextPageLink = document.querySelector<HTMLAnchorElement>(
        "[data-pagination-next]",
      );
      const leftKey = document.querySelector('[data-key="left"]');
      const rightKey = document.querySelector('[data-key="right"]');

      document.addEventListener("keydown", (e) => {
        // Don't navigate if user is typing in an input
        if (
          e.target instanceof HTMLInputElement ||
          e.target instanceof HTMLTextAreaElement ||
          (e.target as HTMLElement)?.isContentEditable
        ) {
          return;
        }

        // Arrow key navigation
        if (e.key === "ArrowLeft" && prevPageLink) {
          leftKey?.classList.add("ring-2", "ring-primary");
          setTimeout(
            () => leftKey?.classList.remove("ring-2", "ring-primary"),
            150,
          );
          window.location.href = prevPageLink.href;
        } else if (e.key === "ArrowRight" && nextPageLink) {
          rightKey?.classList.add("ring-2", "ring-primary");
          setTimeout(
            () => rightKey?.classList.remove("ring-2", "ring-primary"),
            150,
          );
          window.location.href = nextPageLink.href;
        }
      });
    }
    initKeyboardNav();
    document.addEventListener("astro:page-load", initKeyboardNav);

    // Sidebar scroll persistence
    function initSidebarScroll() {
      const STORAGE_KEY = "sidebar-scroll-position";
      const sidebar = document.getElementById("sidebar-scroll-container");

      if (!sidebar) return;

      // Restore scroll position (always do this)
      const savedPosition = sessionStorage.getItem(STORAGE_KEY);
      if (savedPosition) {
        requestAnimationFrame(() => {
          sidebar.scrollTop = parseInt(savedPosition, 10);
        });
      }

      // Only add listeners once
      if (sidebar.hasAttribute("data-scroll-initialized")) return;
      sidebar.setAttribute("data-scroll-initialized", "true");

      // Save on scroll (debounced)
      let timeout: ReturnType<typeof setTimeout>;
      sidebar.addEventListener("scroll", () => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          sessionStorage.setItem(STORAGE_KEY, sidebar.scrollTop.toString());
        }, 50);
      });

      // Save on link click (before navigation)
      sidebar.querySelectorAll("a").forEach((link) => {
        link.addEventListener("click", () => {
          sessionStorage.setItem(STORAGE_KEY, sidebar.scrollTop.toString());
        });
      });
    }
    initSidebarScroll();
    document.addEventListener("astro:page-load", initSidebarScroll);

    // Copy buttons for markdown code fences in prose
    function initProseCodeCopyButtons() {
      document.querySelectorAll<HTMLPreElement>(".prose pre").forEach((pre) => {
        if (pre.closest(".not-prose")) return;
        if (pre.closest("[data-codeblock]")) return;
        if (pre.closest("[data-component-preview]")) return;
        if (pre.parentElement?.hasAttribute("data-prose-code-wrapper")) return;

        const code = pre.querySelector("code");
        if (!code) return;

        // Wrap the pre in a relative container (like CodeBlock does)
        const wrapper = document.createElement("div");
        wrapper.className = "relative";
        wrapper.setAttribute("data-prose-code-wrapper", "");
        pre.parentNode?.insertBefore(wrapper, pre);
        wrapper.appendChild(pre);

        const button = document.createElement("button");
        button.type = "button";
        button.className =
          "absolute top-0 right-4 text-muted-foreground hover:text-foreground transition-colors z-10";
        button.title = "Copy to clipboard";

        const clipboardIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>`;
        const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M20 6 9 17l-5-5"/></svg>`;

        button.innerHTML = clipboardIcon;

        button.addEventListener("click", async () => {
          const text = code.textContent || "";
          try {
            await navigator.clipboard.writeText(text);
            button.innerHTML = checkIcon;
            setTimeout(() => {
              button.innerHTML = clipboardIcon;
            }, 2000);
          } catch (err) {
            console.error("Failed to copy:", err);
          }
        });

        wrapper.appendChild(button);
      });
    }
    initProseCodeCopyButtons();
    document.addEventListener("astro:page-load", initProseCodeCopyButtons);
  </script>
</BaseLayout>
