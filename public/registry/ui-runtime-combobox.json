{
  "name": "ui-runtime-combobox",
  "type": "utility",
  "description": "Shared combobox initialization runtime",
  "files": [
    {
      "name": "runtime/combobox.ts",
      "path": "utils/runtime/combobox.ts",
      "content": "export function initComboboxes() {\n  document.querySelectorAll(\"[data-combobox]\").forEach((combobox) => {\n    if (combobox.hasAttribute(\"data-combobox-initialized\")) return;\n    combobox.setAttribute(\"data-combobox-initialized\", \"true\");\n\n    const triggerLabel = combobox.querySelector(\"[data-combobox-value]\") as\n      | HTMLElement\n      | null;\n    const popoverTrigger = combobox.querySelector(\"[data-popover-trigger]\") as\n      | HTMLElement\n      | null;\n    const popoverContent = combobox.querySelector(\"[data-popover-content]\") as\n      | HTMLElement\n      | null;\n    const hiddenInput = combobox.querySelector(\"[data-combobox-input]\") as\n      | HTMLInputElement\n      | null;\n    const clearButton = combobox.querySelector(\"[data-combobox-clear]\") as\n      | HTMLElement\n      | null;\n    const chevronIcon = combobox.querySelector(\"[data-combobox-chevron]\") as\n      | HTMLElement\n      | null;\n    const searchInput = combobox.querySelector(\"[data-command-input]\") as\n      | HTMLInputElement\n      | null;\n    const placeholder =\n      combobox.getAttribute(\"data-combobox-placeholder\") || \"Select an option\";\n    const isDisabled = combobox.getAttribute(\"data-combobox-disabled\") === \"true\";\n    const isClearable =\n      combobox.getAttribute(\"data-combobox-clearable\") === \"true\";\n    const items = Array.from(\n      combobox.querySelectorAll(\"[data-combobox-item]\")\n    ) as HTMLElement[];\n    const separators = Array.from(\n      combobox.querySelectorAll(\"[data-combobox-group-separator]\")\n    ) as HTMLElement[];\n\n    function getItemLabel(item: HTMLElement): string {\n      return (\n        item.getAttribute(\"data-label\") ||\n        item.querySelector(\".flex-1\")?.textContent?.trim() ||\n        item.textContent?.trim() ||\n        \"\"\n      );\n    }\n\n    function updateGroupSeparators() {\n      if (separators.length === 0) return;\n      const groups = Array.from(\n        combobox.querySelectorAll(\"[data-command-group]\")\n      ) as HTMLElement[];\n\n      groups.forEach((group, index) => {\n        const hasVisibleItems = Array.from(\n          group.querySelectorAll(\"[data-combobox-item]\")\n        ).some((item) => !(item as HTMLElement).hidden);\n\n        if (index >= separators.length) return;\n\n        const nextVisibleGroupExists = groups.slice(index + 1).some((nextGroup) =>\n          Array.from(nextGroup.querySelectorAll(\"[data-combobox-item]\")).some(\n            (item) => !(item as HTMLElement).hidden\n          )\n        );\n\n        separators[index].hidden = !(hasVisibleItems && nextVisibleGroupExists);\n      });\n    }\n\n    function updateClearVisibility(hasSelection: boolean) {\n      if (clearButton) {\n        clearButton.classList.toggle(\"hidden\", !hasSelection || isDisabled);\n      }\n      if (chevronIcon) {\n        const shouldShowChevron = !isClearable || !hasSelection || isDisabled;\n        chevronIcon.classList.toggle(\"hidden\", !shouldShowChevron);\n      }\n    }\n\n    function setSelectedValue(nextValue: string, emit = true) {\n      let selectedLabel = \"\";\n\n      items.forEach((item) => {\n        const itemValue = item.getAttribute(\"data-value\") || \"\";\n        const isSelected = itemValue === nextValue;\n        const indicator = item.querySelector(\n          \"[data-combobox-item-indicator]\"\n        ) as HTMLElement | null;\n\n        if (isSelected) {\n          selectedLabel = getItemLabel(item);\n        }\n\n        item.setAttribute(\"data-selected\", isSelected ? \"true\" : \"false\");\n        item.setAttribute(\"aria-selected\", isSelected ? \"true\" : \"false\");\n        indicator?.classList.toggle(\"opacity-100\", isSelected);\n        indicator?.classList.toggle(\"opacity-0\", !isSelected);\n      });\n\n      if (triggerLabel) {\n        triggerLabel.textContent = selectedLabel || placeholder;\n      }\n\n      if (hiddenInput) {\n        hiddenInput.value = nextValue;\n      }\n\n      combobox.setAttribute(\"data-combobox-value\", nextValue);\n      updateClearVisibility(Boolean(selectedLabel));\n\n      if (emit) {\n        combobox.dispatchEvent(\n          new CustomEvent(\"combobox-change\", {\n            detail: {\n              value: nextValue,\n              label: selectedLabel || placeholder,\n            },\n            bubbles: true,\n          })\n        );\n      }\n    }\n\n    function closePopover() {\n      if (popoverContent) {\n        popoverContent.hidden = true;\n      }\n      if (popoverTrigger) {\n        popoverTrigger.setAttribute(\"aria-expanded\", \"false\");\n        popoverTrigger.focus();\n      }\n    }\n\n    const initialValue = hiddenInput?.value\n      ? hiddenInput.value\n      : combobox.getAttribute(\"data-combobox-value\") || \"\";\n    setSelectedValue(initialValue, false);\n    updateGroupSeparators();\n\n    clearButton?.addEventListener(\"click\", (event) => {\n      event.preventDefault();\n      event.stopPropagation();\n      if (isDisabled) return;\n      setSelectedValue(\"\");\n      if (searchInput) {\n        searchInput.value = \"\";\n        searchInput.dispatchEvent(new Event(\"input\", { bubbles: true }));\n        updateGroupSeparators();\n      }\n    });\n    clearButton?.addEventListener(\"keydown\", (event) => {\n      const keyEvent = event as KeyboardEvent;\n      if (keyEvent.key !== \"Enter\" && keyEvent.key !== \" \") return;\n      keyEvent.preventDefault();\n      keyEvent.stopPropagation();\n      if (isDisabled) return;\n      setSelectedValue(\"\");\n      if (searchInput) {\n        searchInput.value = \"\";\n        searchInput.dispatchEvent(new Event(\"input\", { bubbles: true }));\n        updateGroupSeparators();\n      }\n    });\n\n    if (isDisabled) {\n      updateClearVisibility(Boolean(initialValue));\n      return;\n    }\n\n    combobox.addEventListener(\"command-select\", (event) => {\n      const customEvent = event as CustomEvent<{ value?: string }>;\n      const selectedValue = customEvent.detail?.value || \"\";\n\n      if (!selectedValue) return;\n\n      const selectedItem = items.find(\n        (item) => (item.getAttribute(\"data-value\") || \"\") === selectedValue\n      );\n\n      if (!selectedItem) return;\n      if (selectedItem.getAttribute(\"aria-disabled\") === \"true\") return;\n\n      setSelectedValue(selectedValue);\n      closePopover();\n    });\n\n    searchInput?.addEventListener(\"input\", updateGroupSeparators);\n  });\n}\n"
    }
  ]
}
