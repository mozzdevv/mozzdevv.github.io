{
  "name": "ui-runtime-command",
  "type": "utility",
  "description": "Shared command and command dialog initialization runtime",
  "files": [
    {
      "name": "runtime/command.ts",
      "path": "utils/runtime/command.ts",
      "content": "import { generateId } from \"@/utils/focus-trap\";\n\nexport function initCommands() {\n  document.querySelectorAll(\"[data-command]\").forEach((command) => {\n    if (command.hasAttribute(\"data-command-initialized\")) return;\n    command.setAttribute(\"data-command-initialized\", \"true\");\n\n    const input = command.querySelector(\"[data-command-input]\") as\n      | HTMLInputElement\n      | null;\n    const list = command.querySelector(\"[data-command-list]\") as\n      | HTMLElement\n      | null;\n    const empty = command.querySelector(\"[data-command-empty]\") as\n      | HTMLElement\n      | null;\n    const items = Array.from(\n      command.querySelectorAll(\"[data-command-item]\")\n    ) as HTMLElement[];\n    const groups = command.querySelectorAll(\"[data-command-group]\");\n\n    if (list && !list.id) {\n      list.id = generateId(\"command-list\");\n    }\n\n    items.forEach((item, index) => {\n      if (!item.id) {\n        item.id = generateId(`command-item-${index}`);\n      }\n    });\n\n    if (input && list) {\n      input.setAttribute(\"aria-controls\", list.id);\n    }\n\n    let selectedIndex = -1;\n\n    const updateSelection = () => {\n      const visibleItems = items.filter((item) => !item.hidden);\n\n      visibleItems.forEach((item, index) => {\n        if (index === selectedIndex) {\n          item.setAttribute(\"data-selected\", \"true\");\n          item.setAttribute(\"aria-selected\", \"true\");\n          item.scrollIntoView({ block: \"nearest\" });\n          if (input) {\n            input.setAttribute(\"aria-activedescendant\", item.id);\n          }\n        } else {\n          item.removeAttribute(\"data-selected\");\n          item.setAttribute(\"aria-selected\", \"false\");\n        }\n      });\n\n      if (selectedIndex === -1 && input) {\n        input.removeAttribute(\"aria-activedescendant\");\n      }\n    };\n\n    const filterItems = () => {\n      if (!input) return;\n\n      const query = input.value.toLowerCase().trim();\n      let visibleCount = 0;\n\n      items.forEach((item) => {\n        const text = item.textContent?.toLowerCase() || \"\";\n        const matches = query === \"\" || text.includes(query);\n        item.hidden = !matches;\n        if (matches) visibleCount += 1;\n      });\n\n      groups.forEach((group) => {\n        const groupItems = group.querySelectorAll(\"[data-command-item]\");\n        const hasVisibleItems = Array.from(groupItems).some(\n          (item) => !(item as HTMLElement).hidden\n        );\n        (group as HTMLElement).hidden = !hasVisibleItems;\n      });\n\n      if (empty) {\n        empty.hidden = visibleCount > 0 || query === \"\";\n      }\n\n      selectedIndex = -1;\n      updateSelection();\n    };\n\n    const handleKeyDown = (e: KeyboardEvent) => {\n      const visibleItems = items.filter((item) => !item.hidden);\n      if (visibleItems.length === 0) return;\n\n      switch (e.key) {\n        case \"ArrowDown\":\n          e.preventDefault();\n          selectedIndex = Math.min(selectedIndex + 1, visibleItems.length - 1);\n          updateSelection();\n          break;\n        case \"ArrowUp\":\n          e.preventDefault();\n          selectedIndex = Math.max(selectedIndex - 1, 0);\n          updateSelection();\n          break;\n        case \"Enter\":\n          e.preventDefault();\n          if (selectedIndex >= 0 && visibleItems[selectedIndex]) {\n            visibleItems[selectedIndex].click();\n          }\n          break;\n        case \"Escape\":\n          input?.blur();\n          break;\n      }\n    };\n\n    if (input) {\n      input.addEventListener(\"input\", filterItems);\n      input.addEventListener(\"keydown\", handleKeyDown);\n    }\n\n    items.forEach((item) => {\n      item.addEventListener(\"click\", () => {\n        const value = item.getAttribute(\"data-value\") || item.textContent;\n        command.dispatchEvent(\n          new CustomEvent(\"command-select\", {\n            detail: { value },\n            bubbles: true,\n          })\n        );\n      });\n    });\n  });\n}\n\nexport function initCommandDialogs() {\n  document.querySelectorAll(\"[data-command-dialog]\").forEach((dialog) => {\n    if (dialog.hasAttribute(\"data-dialog-initialized\")) return;\n    dialog.setAttribute(\"data-dialog-initialized\", \"true\");\n\n    const trigger = dialog.querySelector(\"[data-command-dialog-trigger]\");\n    const overlay = dialog.querySelector(\"[data-command-dialog-overlay]\") as\n      | HTMLElement\n      | null;\n    const content = dialog.querySelector(\"[data-command-dialog-content]\") as\n      | HTMLElement\n      | null;\n\n    const openDialog = () => {\n      if (overlay) overlay.hidden = false;\n      if (content) {\n        content.hidden = false;\n        const input = content.querySelector(\"[data-command-input]\") as\n          | HTMLInputElement\n          | null;\n        input?.focus();\n      }\n      document.body.style.overflow = \"hidden\";\n    };\n\n    const closeDialog = () => {\n      if (overlay) overlay.hidden = true;\n      if (content) content.hidden = true;\n      document.body.style.overflow = \"\";\n\n      const input = content?.querySelector(\"[data-command-input]\") as\n        | HTMLInputElement\n        | null;\n      if (input) {\n        input.value = \"\";\n        input.dispatchEvent(new Event(\"input\"));\n      }\n    };\n\n    trigger?.addEventListener(\"click\", openDialog);\n\n    overlay?.addEventListener(\"click\", (e) => {\n      if (e.target === overlay) closeDialog();\n    });\n\n    document.addEventListener(\"keydown\", (e) => {\n      if ((e.metaKey || e.ctrlKey) && e.key === \"k\") {\n        e.preventDefault();\n        if (overlay?.hidden) {\n          openDialog();\n        } else {\n          closeDialog();\n        }\n      }\n\n      if (e.key === \"Escape\" && overlay && !overlay.hidden) {\n        closeDialog();\n      }\n    });\n  });\n}\n"
    }
  ]
}
